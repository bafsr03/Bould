(function(){"use strict";const Re="Something went wrong",Ue="Bould fit assistant",we={intro:{title:"Find your best fit",subtitle:"Upload a T-pose photo to unlock a personalized size recommendation.",compact:!1,describe:!0},loading:{title:"",subtitle:"",compact:!0,describe:!1},form:{compact:!0,ariaLabel:"Bould fit assistant form"},result:{compact:!0,ariaLabel:"Bould fit assistant result"},error:{compact:!0,ariaLabel:"Bould fit assistant error"}},He=2600,We=600,ze=220,ue=["Sizing assistant is reviewing your fit details...","Hang tight - preparing your personalized fit notes."],ve="Upgrade to continue using Bould.";function Se(n,e){const{header:t,headerEyebrow:i,headerTitle:s,headerSubtitle:o,modal:r,headerDefaults:a}=e,d=we[n]||we.form||{},m=typeof d.eyebrow=="string"?d.eyebrow:"",S=typeof d.title=="string"?d.title:"",I=typeof d.subtitle=="string"?d.subtitle:"",M=!!d.describe;t&&t.classList.toggle("bould-widget__header--compact",!!d.compact),i&&(m?(i.hidden=!1,i.textContent=m):(i.hidden=!0,i.textContent=a.eyebrow)),s&&(S?(s.hidden=!1,s.textContent=S):(s.hidden=!0,s.textContent="")),o&&(I?(o.hidden=!1,o.textContent=I):(o.hidden=!0,o.textContent="")),r&&(S&&s&&!s.hidden?(r.setAttribute("aria-labelledby",s.id),r.removeAttribute("aria-label")):(r.removeAttribute("aria-labelledby"),r.setAttribute("aria-label",d.ariaLabel||Ue)),M&&o&&!o.hidden?r.setAttribute("aria-describedby",o.id):r.removeAttribute("aria-describedby"))}class Ge{constructor(e){this.introScreen=e.introScreen,this.introSteps=e.introSteps||[],this.introActions=e.introActions,this.animationTimers=[],this.heightLock={width:0,height:0},this.resizeObserver=null,this.init()}init(){typeof ResizeObserver=="function"&&this.introScreen&&(this.resizeObserver=new ResizeObserver(()=>{!this.introScreen||this.introScreen.hidden||this.lockHeight(!1)}),this.resizeObserver.observe(this.introScreen))}clearAnimation(){this.animationTimers.length&&(this.animationTimers.forEach(e=>clearTimeout(e)),this.animationTimers=[]),this.introSteps.length&&this.introSteps.forEach(e=>{e.classList.remove("is-visible","is-highlight"),e.setAttribute("aria-hidden","true"),e.style.opacity="0",e.style.visibility="hidden",e.style.transitionDelay="",e.classList.remove("is-active-intro"),this.setProgress(e,0)}),this.introActions&&(this.introActions.classList.remove("is-visible"),this.introActions.hidden=!0,this.introActions.setAttribute("hidden",""),this.introActions.setAttribute("aria-hidden","true")),this.introScreen&&(this.unlockHeight(),this.introScreen.classList.remove("is-animating")),this.heightLock={width:0,height:0}}queueTimeout(e,t){const i=setTimeout(e,Math.max(0,t));return this.animationTimers.push(i),i}setProgress(e,t){if(!e)return;const i=typeof t=="number"?t:parseFloat(t),s=Math.max(0,Math.min(1,Number.isFinite(i)?i:0));e.style.setProperty("--intro-progress",s.toFixed(3))}updateProgress(e){if(!this.introSteps.length)return;const t=typeof e=="number"?e:-1;this.introSteps.forEach((i,s)=>{let o=0;if(t>=0)if(s===t)o=1,i.classList.add("is-active-intro");else if(s<t){const r=t-s;r===1?o=.64:r===2?o=.44:o=.3,i.classList.remove("is-active-intro")}else o=0,i.classList.remove("is-active-intro");else i.classList.remove("is-active-intro");this.setProgress(i,o)})}measureNaturalHeight(){if(!this.introScreen)return 0;const e=this.introScreen.getBoundingClientRect(),t=this.introScreen.cloneNode(!0);t.style.position="absolute",t.style.top="-9999px",t.style.left="0",t.style.visibility="hidden",t.style.pointerEvents="none",t.style.opacity="0",t.style.transform="none",t.style.height="auto",t.style.minHeight="0",e&&e.width&&(t.style.width=Math.round(e.width)+"px"),t.classList.remove("is-animating"),t.querySelectorAll("[hidden]").forEach(r=>{r.hidden=!1,r.removeAttribute("hidden")}),t.querySelectorAll(".bould-widget__intro-step").forEach(r=>{r.classList.add("is-visible","is-active-intro"),r.classList.remove("is-highlight"),r.removeAttribute("style"),r.style.setProperty("--intro-progress","1")});const i=t.querySelector(".bould-widget__actions--intro");i&&(i.hidden=!1,i.removeAttribute("hidden"),i.classList.add("is-visible"),i.removeAttribute("style"),i.setAttribute("aria-hidden","false"));const s=this.introScreen.parentNode;if(!s)return 0;s.insertBefore(t,this.introScreen);const o=t.getBoundingClientRect();return s.removeChild(t),o&&o.height?Math.ceil(o.height):0}lockHeight(e){if(!this.introScreen)return;const t=this.introScreen.getBoundingClientRect(),i=t&&t.width?Math.round(t.width):0;if(i<=0){this.heightLock.height&&(this.introScreen.style.minHeight=this.heightLock.height+"px",this.introScreen.style.height=this.heightLock.height+"px");return}if(!e&&this.heightLock.height&&this.heightLock.width===i){this.introScreen.style.minHeight=this.heightLock.height+"px",this.introScreen.style.height=this.heightLock.height+"px";return}const s=this.measureNaturalHeight();s>0&&(this.heightLock={width:i,height:s},this.introScreen.style.minHeight=s+"px",this.introScreen.style.height=s+"px",this.introScreen.setAttribute("data-height-lock","true"))}unlockHeight(){this.introScreen&&(this.introScreen.style.height="",this.introScreen.style.minHeight="",this.introScreen.removeAttribute("data-height-lock"))}runAnimation(){if(!this.introScreen)return;if(this.clearAnimation(),this.lockHeight(!1),this.updateProgress(-1),!this.introSteps.length){this.introActions&&(this.introActions.hidden=!1,this.introActions.removeAttribute("hidden"),this.introActions.classList.add("is-visible"),this.introActions.setAttribute("aria-hidden","false")),this.unlockHeight();return}if(typeof window.matchMedia=="function"&&window.matchMedia("(prefers-reduced-motion: reduce)").matches){this.lockHeight(!0),this.introSteps.forEach(a=>{a.setAttribute("aria-hidden","false"),a.style.visibility="",a.style.opacity="",a.classList.add("is-visible"),this.setProgress(a,1),a.classList.add("is-active-intro")}),this.introActions&&(this.introActions.hidden=!1,this.introActions.removeAttribute("hidden"),this.introActions.classList.add("is-visible"),this.introActions.setAttribute("aria-hidden","false")),this.introScreen?(this.introScreen.classList.remove("is-animating"),requestAnimationFrame(()=>{this.unlockHeight()})):this.unlockHeight();return}this.introScreen.classList.add("is-animating");const t=220,i=1e3,s=620,o=360;this.lockHeight(!1);let r=t;this.introSteps.forEach((a,d)=>{this.queueTimeout(()=>{requestAnimationFrame(()=>{a.style.transitionDelay="0ms",a.setAttribute("aria-hidden","false"),a.style.visibility="",a.style.opacity="",a.classList.add("is-visible"),this.updateProgress(d)})},r),d===this.introSteps.length-1&&this.queueTimeout(()=>{this.introActions&&(this.introActions.hidden=!1,this.introActions.removeAttribute("hidden"),this.introActions.classList.add("is-visible"),this.introActions.setAttribute("aria-hidden","false")),this.introScreen?(this.introScreen.classList.remove("is-animating"),requestAnimationFrame(()=>{this.unlockHeight()})):this.unlockHeight()},r+s+o),r+=i})}}class Oe{constructor(e){this.widgetId=e,this.viewer=null,this.image=null,this.frame=null,this.closeBtn=null,this.hideTimer=null,this.returnFocusEl=null,this.handleKeydown=this.handleKeydown.bind(this),this.init()}init(){this.viewer=this.createViewer(),this.viewer&&(this.image=this.viewer.querySelector(".bould-widget__image-viewer__img"),this.frame=this.viewer.querySelector(".bould-widget__image-viewer__frame"),this.closeBtn=this.viewer.querySelector(".bould-widget__image-viewer__close"),this.bindEvents())}createViewer(){if(typeof document>"u"||!document.body)return null;if(this.widgetId){const o=document.querySelectorAll(".bould-widget__image-viewer");for(let r=0;r<o.length;r+=1){const a=o[r];if(a&&a.getAttribute("data-widget-id")===this.widgetId)return a}}const e=document.createElement("div");e.className="bould-widget__image-viewer",this.widgetId&&e.setAttribute("data-widget-id",this.widgetId),e.hidden=!0,e.setAttribute("aria-hidden","true");const t=document.createElement("div");t.className="bould-widget__image-viewer__frame",t.setAttribute("role","dialog"),t.setAttribute("aria-modal","true"),t.setAttribute("aria-label","Result preview"),t.tabIndex=-1;const i=document.createElement("button");i.type="button",i.className="bould-widget__image-viewer__close",i.setAttribute("aria-label","Close result preview"),i.textContent="×";const s=document.createElement("img");return s.className="bould-widget__image-viewer__img",s.alt="Try on result preview",t.appendChild(i),t.appendChild(s),e.appendChild(t),document.body.appendChild(e),e}bindEvents(){this.viewer&&this.viewer.addEventListener("click",e=>{(!this.frame||e.target===this.viewer||!this.frame.contains(e.target))&&this.close()}),this.closeBtn&&this.closeBtn.addEventListener("click",e=>{e&&(e.preventDefault(),e.stopPropagation()),this.close()}),this.frame&&this.frame.addEventListener("click",e=>{e.stopPropagation()})}open(e,t,i){!this.viewer||!this.image||!e||(this.hideTimer&&(clearTimeout(this.hideTimer),this.hideTimer=null),this.returnFocusEl=i instanceof HTMLElement?i:null,this.image.src=e,this.image.alt=t||"Try on result",this.frame&&this.frame.setAttribute("aria-label",t?"Result preview: "+t:"Result preview"),this.viewer.hidden=!1,this.viewer.setAttribute("aria-hidden","false"),requestAnimationFrame(()=>{this.viewer.classList.add("is-visible")}),document.addEventListener("keydown",this.handleKeydown),this.closeBtn&&typeof this.closeBtn.focus=="function"&&setTimeout(()=>{try{this.closeBtn.focus({preventScroll:!0})}catch{this.closeBtn.focus()}},50))}close(e){if(!this.viewer||this.viewer.hidden)return;this.hideTimer&&(clearTimeout(this.hideTimer),this.hideTimer=null),this.viewer.classList.remove("is-visible"),document.removeEventListener("keydown",this.handleKeydown);const t=()=>{if(this.hideTimer=null,this.image&&this.image.removeAttribute("src"),this.viewer.setAttribute("aria-hidden","true"),this.viewer.hidden=!0,this.returnFocusEl&&typeof this.returnFocusEl.focus=="function")try{this.returnFocusEl.focus({preventScroll:!0})}catch{this.returnFocusEl.focus()}this.returnFocusEl=null};e?t():this.hideTimer=setTimeout(t,200)}handleKeydown(e){e&&(e.key==="Escape"||e.key==="Esc")&&(e.preventDefault(),this.close())}}class je{constructor(e){this.loadingScreen=e.loadingScreen,this.loadingStatusEl=e.loadingStatusEl,this.loadingFeedbackEl=e.loadingFeedbackEl,this.loadingGeneratingEl=e.loadingGeneratingEl,this.activeFeedbackCycle=null,this.defaultText=this.loadingStatusEl?this.loadingStatusEl.dataset.defaultText||this.loadingStatusEl.textContent:"",this.loadingStatusEl&&!this.loadingStatusEl.dataset.defaultText&&(this.loadingStatusEl.dataset.defaultText=this.defaultText)}setGeneratingActive(e){this.loadingGeneratingEl&&(e?(this.loadingGeneratingEl.hidden=!1,this.loadingGeneratingEl.removeAttribute("hidden"),this.loadingGeneratingEl.classList.add("is-active"),this.loadingGeneratingEl.setAttribute("aria-hidden","false")):(this.loadingGeneratingEl.classList.remove("is-active"),this.loadingGeneratingEl.setAttribute("aria-hidden","true"),this.loadingGeneratingEl.hidden=!0))}stopFeedbackCycle(e){this.activeFeedbackCycle&&typeof this.activeFeedbackCycle.cancel=="function"&&this.activeFeedbackCycle.cancel(!!e),this.activeFeedbackCycle=null}reset(){if(this.stopFeedbackCycle(!0),this.loadingStatusEl){this.loadingStatusEl.hidden=!1;const e=this.loadingStatusEl.dataset.defaultText||this.defaultText;e&&(this.loadingStatusEl.textContent=e)}this.loadingFeedbackEl&&(this.loadingFeedbackEl.hidden=!0,this.loadingFeedbackEl.classList.remove("is-visible"),this.loadingFeedbackEl.textContent=""),this.setGeneratingActive(!0)}startFeedback(e,t){const i=Array.isArray(e)?e.map(_=>typeof _=="string"?_.replace(/\s+/g," ").trim():"").filter(Boolean):[];if(!this.loadingFeedbackEl||!i.length){const _=i.length?i[i.length-1]:"";return{promise:Promise.resolve({finalMessage:_||"",cancelled:!1}),cancel:function(){}}}const s=Object.assign({loop:!1,holdMs:He,fadeMs:We,finalHoldMs:ze,initialDelay:30,hideStatus:!0,loopCount:null},t||{}),o=this.loadingFeedbackEl;s.hideStatus&&this.loadingStatusEl&&(this.loadingStatusEl.hidden=!0),o.hidden=!1,o.classList.remove("is-visible"),o.textContent="";let r=!1,a=null;const d=[],m=typeof s.loopCount=="number"&&s.loopCount>0?s.loopCount:null;let S=0;const I=()=>{for(;d.length;)clearTimeout(d.pop())},M=(_,B)=>{if(r)return;r=!0,I();const G=B!=null&&B!==""?B:o.textContent||i[i.length-1]||"";a&&a({finalMessage:G,cancelled:_})},E=_=>{if(r)return;if(!i.length){M(!0,"");return}const B=_%i.length,G=i[B];o.classList.remove("is-visible"),o.textContent=G,d.push(setTimeout(()=>{r||(o.classList.add("is-visible"),d.push(setTimeout(()=>{if(r)return;const O=B===i.length-1,ae=(B+1)%i.length;if(s.loop){if(ae===0&&(S+=1,m&&S>=m)){M(!1,G);return}o.classList.remove("is-visible"),d.push(setTimeout(()=>{r||E(ae)},s.fadeMs))}else O?M(!1,G):(o.classList.remove("is-visible"),d.push(setTimeout(()=>{r||E(B+1)},s.fadeMs)))},s.holdMs)))},50))},V={promise:new Promise(_=>{a=_,d.push(setTimeout(()=>{E(0)},Math.max(0,s.initialDelay)))}).then(_=>(this.activeFeedbackCycle===V&&(this.activeFeedbackCycle=null),_)),cancel:_=>{if(r){_&&o.classList.remove("is-visible");return}_&&o.classList.remove("is-visible"),M(!0)}};return this.activeFeedbackCycle=V,V}}class $e{constructor(e){this.resultScreen=e.resultScreen,this.resultImageEl=e.resultImageEl,this.resultSizeEl=e.resultSizeEl,this.resultConfidenceEl=e.resultConfidenceEl,this.resultFeedbackEl=e.resultFeedbackEl,this.resultStageEls=e.resultStageEls||[]}reset(){this.resultStageEls.forEach(e=>{e&&e.classList.remove("is-visible")}),this.resultImageEl&&(this.resultImageEl.removeAttribute("src"),this.resultImageEl.hidden=!1),this.resultSizeEl&&(this.resultSizeEl.textContent="",this.resultSizeEl.hidden=!1),this.resultConfidenceEl&&(this.resultConfidenceEl.textContent="",this.resultConfidenceEl.hidden=!1),this.resultFeedbackEl&&(this.resultFeedbackEl.textContent="",this.resultFeedbackEl.hidden=!1,this.resultFeedbackEl.classList.remove("is-visible"))}reveal(e,t){this.resultScreen&&(this.resultImageEl&&(e.imageUrl?(this.resultImageEl.hidden=!1,this.resultImageEl.src!==e.imageUrl&&(this.resultImageEl.src=e.imageUrl)):(this.resultImageEl.removeAttribute("src"),this.resultImageEl.hidden=!0)),this.resultSizeEl&&(e.sizeText?(this.resultSizeEl.textContent=e.sizeText,this.resultSizeEl.hidden=!1):(this.resultSizeEl.textContent="",this.resultSizeEl.hidden=!0)),this.resultConfidenceEl&&(this.resultConfidenceEl.hidden=!0),this.resultFeedbackEl&&(e.feedbackText?(this.resultFeedbackEl.textContent=e.feedbackText,this.resultFeedbackEl.hidden=!1):(this.resultFeedbackEl.textContent="",this.resultFeedbackEl.hidden=!0),this.resultFeedbackEl.classList.remove("is-visible")),typeof t=="function"&&t("result"),requestAnimationFrame(()=>{requestAnimationFrame(()=>{this.resultStageEls.forEach(i=>{if(i){if(i===this.resultImageEl&&!e.imageUrl){i.classList.remove("is-visible");return}i.classList.add("is-visible")}}),this.resultFeedbackEl&&this.resultFeedbackEl.classList.contains("bould-widget__fade-text")&&e.feedbackText&&this.resultFeedbackEl.classList.add("is-visible")})}))}}function L(n){return String(n??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function Ke(n){return L(n).replace(/\r?\n/g,"<br />")}function _e(){try{return!!(window.Shopify&&window.Shopify.designMode)}catch{return!1}}function Ve(){try{if(navigator!=null&&navigator.userAgentData&&typeof navigator.userAgentData.mobile=="boolean")return navigator.userAgentData.mobile}catch{}const n=(navigator.userAgent||navigator.vendor||window.opera&&window.opera.toString&&window.opera.toString()||"").toLowerCase(),e=/(android|iphone|ipad|ipod|windows phone|blackberry|bb10|mobile)/i.test(n),t=typeof window.matchMedia=="function"&&window.matchMedia("(pointer: coarse)").matches,i=typeof window.matchMedia=="function"&&window.matchMedia("(max-width: 820px)").matches;return e||t&&i}function Je(n){if(!n)return[];const e=String(n).replace(/\s+/g," ").match(/[^.!?]+[.!?]*/g);return e?e.map(function(t){return t.trim()}).filter(Boolean):[String(n).trim()]}function Xe(n){return String(n||"").split("_").map(function(e){return e?e.charAt(0).toUpperCase()+e.slice(1):""}).filter(Boolean).join(" ")}function Qe(n,e){if(!n||typeof n!="object")return"";const i=n[e==="inch"?"slacks_in":"slacks_cm"];if(!i||typeof i!="object")return"";const s=Object.entries(i).map(function(a){const d=a[0],m=Number(a[1]);return!d||Number.isNaN(m)?null:[d,m]}).filter(Boolean).sort(function(a,d){return Math.abs(d[1])-Math.abs(a[1])});if(!s.length)return"";const o=s.slice(0,3).map(function(a){const d=Xe(a[0]),m=a[1],S=(m>0?"+":"")+m.toFixed(1);return d+" "+S});return"Slack ("+(e==="inch"?"in":"cm")+"): "+o.join(", ")}function Ye(n,e=""){if(!n||typeof n!="object")return["We're reviewing your fit details...","Hang tight - we're rendering your try-on preview now."];const t=n.tailor_feedback_sequence||n.tailor_feedbacks||n.tailorFeedbackSequence||n.tailorFeedbacks||n.tailor_feedback||n.tailorFeedback;let i=[];if(Array.isArray(t)?i=t:t&&typeof t=="object"&&Array.isArray(t.messages)?i=t.messages:t!=null&&(i=[t]),i=i.map(function(r){return String(r||"").replace(/\s+/g," ").trim()}).filter(Boolean),!i.length&&e&&(i=[e]),i.length===1){const r=i[0],a=r.split(/\n+/).map(function(d){return d.replace(/\s+/g," ").trim()}).filter(Boolean);if(a.length>=2)i=[a[0],a.slice(1).join(" ").trim()];else{const d=Je(r);if(d.length>=2){const m=d.slice(1).join(" ").trim();m&&(i=[d[0],m])}}}const s=new Set,o=[];return i.forEach(function(r){s.has(r)||(s.add(r),o.push(r))}),o.length||o.push("We're reviewing your fit details..."),o.length===1&&o.push("Hang tight - we're rendering your try-on preview now."),o.slice(0,3)}function Ze(n){return n?new Promise(function(e){const t=new Image;t.decoding="async",t.onload=function(){e({url:n,loaded:!0})},t.onerror=function(){e({url:n,loaded:!1})},t.src=n}):Promise.resolve({url:"",loaded:!1})}function et(n){const e=Array.isArray(n)?n.filter(Boolean):[];if(!e.length)return Promise.resolve({url:"",loaded:!1});let t=0;return new Promise(function(i){function s(){const o=e[t];Ze(o).then(function(r){if(r.loaded){i(r);return}if(t<e.length-1){console.warn("[Bould Widget] Try-on image failed to load, trying next candidate",o),t+=1,s();return}i({url:o,loaded:!1})})}s()})}function K(n){const e=n.getAttribute("data-product-id")||"";if(e)return e;try{const t=window.ShopifyAnalytics&&window.ShopifyAnalytics.meta&&window.ShopifyAnalytics.meta.product&&window.ShopifyAnalytics.meta.product.id||null;if(t)return`gid://shopify/Product/${t}`}catch{}return""}function tt(n){const e=n.getAttribute("data-product-image")||"";if(e)return e;try{const t=window.ShopifyAnalytics&&window.ShopifyAnalytics.meta&&window.ShopifyAnalytics.meta.product;if(t){if(typeof t.image_url=="string"&&t.image_url)return t.image_url;if(Array.isArray(t.images)&&t.images.length>0)return t.images[0]}}catch{}return""}function Ee(){try{const n=window.Shopify&&window.Shopify.customer;if(n&&(n.id||n.email))return!0}catch{}try{const n=window.ShopifyAnalytics&&window.ShopifyAnalytics.meta;if(n&&(n.page&&n.page.customerId||n.customerId))return!0}catch{}try{const n=document.cookie?document.cookie.split(";"):[];for(let e=0;e<n.length;e+=1){const t=n[e].trim();if(!t)continue;const i=t.indexOf("=");if(i===-1)continue;const s=t.slice(0,i),o=t.slice(i+1);if(s==="customer_signed_in"){const r=o.toLowerCase();if(r==="true"||r==="1"||r==="yes")return!0}}}catch{}return!1}class it{constructor(e,t){this.container=e,this.openBtn=t}ensureStateNotice(){let e=this.container.querySelector(".bould-widget__state");return e||(e=document.createElement("div"),e.className="bould-widget__state",e.hidden=!0,this.openBtn&&typeof this.openBtn.insertAdjacentElement=="function"?this.openBtn.insertAdjacentElement("afterend",e):this.container.appendChild(e)),e}showInline(e,t){const i=this.ensureStateNotice();i.className="bould-widget__state",t==="warning"?i.classList.add("bould-widget__state--warning"):t==="error"&&i.classList.add("bould-widget__state--error"),i.innerHTML=`<p>${L(e)}</p>`,i.hidden=!1}clearInline(){const e=this.container.querySelector(".bould-widget__state");e&&(e.className="bould-widget__state",e.innerHTML="",e.hidden=!0)}ensureUpgradeNotice(){let e=this.container.querySelector(".bould-widget__upgrade");return e||(e=document.createElement("div"),e.className="bould-widget__upgrade",this.container.appendChild(e)),e}applyPlanState(e){const t=e&&e.plan?e.plan:null,i=!!(t&&t.blocked),s=this.container.querySelector(".bould-widget__upgrade"),o=!!(window.Shopify&&window.Shopify.designMode);if(i){const r=t&&t.message?t.message:ve;if(o){const a=s||this.ensureUpgradeNotice();a.textContent=r,a.hidden=!1}else s&&(s.textContent="",s.hidden=!0);this.container.setAttribute("data-plan-blocked","true"),this.openBtn&&(this.openBtn.disabled=!0,this.openBtn.classList.add("bould-widget__open--disabled"),this.openBtn.style.display=o?"":"none",this.openBtn.setAttribute("data-disabled-reason","plan-blocked"),this.openBtn.setAttribute("title",r),this.openBtn.setAttribute("aria-disabled","true"))}else this.container.removeAttribute("data-plan-blocked"),s&&(s.textContent="",s.hidden=!0),this.openBtn&&(this.openBtn.style.display="",this.openBtn.disabled=!1,this.openBtn.classList.remove("bould-widget__open--disabled"),this.openBtn.removeAttribute("data-disabled-reason"),this.openBtn.removeAttribute("title"),this.openBtn.removeAttribute("aria-disabled"))}setOpenButtonDisabled(e,t,i){this.openBtn&&(!e&&this.container.getAttribute("data-plan-blocked")==="true"||(e?(this.openBtn.disabled=!0,this.openBtn.classList.add("bould-widget__open--disabled"),this.openBtn.setAttribute("aria-disabled","true"),t&&this.openBtn.setAttribute("data-disabled-reason",t),i&&this.openBtn.setAttribute("title",i)):(this.openBtn.disabled=!1,this.openBtn.classList.remove("bould-widget__open--disabled"),this.openBtn.removeAttribute("aria-disabled"),(!t||this.openBtn.getAttribute("data-disabled-reason")===t)&&this.openBtn.removeAttribute("data-disabled-reason"),(!i||this.openBtn.getAttribute("title")===i)&&this.openBtn.removeAttribute("title"))))}renderDebugInfo(e){if(!e)return"";const t=[];return e.requestId&&t.push(`Request ID: ${L(e.requestId)}`),e.productId&&t.push(`Product ID: ${L(e.productId)}`),e.conversionStatus&&t.push(`Conversion Status: ${L(e.conversionStatus)}`),e.statusCode&&t.push(`Status Code: ${L(e.statusCode)}`),e.timestamp&&t.push(`Timestamp: ${L(e.timestamp)}`),e.suggestion&&t.push(`Suggestion: ${L(e.suggestion)}`),e.reason&&t.push(`Reason: ${L(e.reason)}`),e.correlationId&&t.push(`Correlation ID: ${L(e.correlationId)}`),e.responseCorrelationId&&t.push(`Response ID: ${L(e.responseCorrelationId)}`),t.length?`<div class="bould-widget__debug-info"><strong>Debug Information:</strong><br>${t.join("<br>")}</div>`:""}}class nt{constructor(e){this.container=e}getStorageKey(){const e=K(this.container);return"bould_result_"+(e?e.replace(/\W/g,"_"):"default")}save(e){if(Ee())try{const t=this.getStorageKey();localStorage.setItem(t,JSON.stringify({details:e,timestamp:Date.now()}))}catch(t){console.warn("[Bould Widget] Failed to save result to storage",t)}}load(){if(!Ee())return null;try{const e=this.getStorageKey(),t=localStorage.getItem(e);return t?JSON.parse(t).details:null}catch(e){return console.warn("[Bould Widget] Failed to load result from storage",e),null}}}class st{constructor(e){this.container=e}getEndpointBase(){const e=this.container.getAttribute("data-api-base");return e&&e!=="use_app_route"&&e!=="use_app_proxy"?e:"/apps/bould"}async fetchStatus(){const e=K(this.container),t=_e();if(!e&&!t)return null;const i=Math.random().toString(36).slice(2,10),s=new URLSearchParams;s.set("intent","status"),e&&s.set("product_id",e),t&&s.set("design_mode","1");const o=`${this.getEndpointBase()}?${s.toString()}`,r=await fetch(o,{headers:{Accept:"application/json","X-Correlation-ID":i}});if(!r.ok){const a=await r.text().catch(()=>"");return console.warn("[Bould Widget] Status check failed",r.status,a),null}return r.json()}getImmediateGate(e){return null}getPreflightGate(e,t){var i,s;if(!e)return null;if(e.plan&&e.plan.blocked)return{heading:"Upgrade required",message:e.plan.message||ve,tone:"warning",action:"close",blockButton:!0,code:"plan-blocked",debug:{requestId:(i=e==null?void 0:e.debug)==null?void 0:i.requestId,planId:e.plan.id,productId:e.productId||K(this.container),reason:"plan_blocked"}};if(!t&&e.isProcessed===!1){const o=e.conversionStatus||"not_ready";let r="Garment isn't ready yet",a="This garment has not been processed yet.",d="warning";return o==="processing"?(r="Garment still processing",a="We are still processing this garment. Please wait a few minutes and try again."):o==="failed"&&(r="Garment conversion failed",a="This garment is not available for try-on.",d="error"),{heading:r,message:a,tone:d,action:"close",blockButton:!1,code:"garment-unprocessed",debug:{requestId:(s=e==null?void 0:e.debug)==null?void 0:s.requestId,productId:e.productId||K(this.container),conversionStatus:o,reason:"garment_unprocessed"}}}return null}}(function(){document.querySelectorAll("[data-bould-widget]").forEach(function(n){const e=n.querySelector(".bould-widget__open"),t=n.querySelector(".bould-widget"),i=n.querySelector(".bould-widget__close"),s=t?t.querySelector(".bould-widget__header"):null,o=s?s.querySelector(".bould-widget__eyebrow"):null,r=s?s.querySelector(".bould-widget__title"):null,a=s?s.querySelector(".bould-widget__subtitle"):null,d={eyebrow:o?o.textContent.trim():"",title:r?r.textContent.trim():"",subtitle:a?a.textContent.trim():""},m=t?t.querySelector(".bould-widget__screen--loading"):null,S=m?m.querySelector(".bould-widget__loading-text"):null,I=m?m.querySelector("[data-loading-feedback]"):null,M=m?m.querySelector("[data-loading-generating]"):null,E=t?t.querySelector(".bould-widget__screen--result"):null,z=E?E.querySelector(".bould-widget__result-image"):null,V=E?E.querySelector(".bould-widget__size"):null,_=E?E.querySelector(".bould-widget__confidence"):null,B=E?E.querySelector(".bould-widget__feedback"):null,G=E?Array.from(E.querySelectorAll(".bould-widget__result-stage")):[],O=t?t.querySelector(".bould-widget__screen--intro"):null,ae=O?Array.from(O.querySelectorAll(".bould-widget__intro-step")):[],Ae=O?O.querySelector(".bould-widget__actions--intro"):null,P=t?t.querySelector(".bould-widget__screen--error [data-action]"):null,ke=P?{label:P.textContent||"Try again",action:P.getAttribute("data-action")||"back-to-form"}:{label:"Try again",action:"back-to-form"};n&&n.classList&&!n.classList.contains("bould-widget--enhanced")&&n.classList.add("bould-widget--enhanced");const rt=n.getAttribute("data-block-id")||""||Math.random().toString(36).slice(2,8),he=new Ge({introScreen:O,introSteps:ae,introActions:Ae}),Ce=new Oe(rt),A=new je({loadingScreen:m,loadingStatusEl:S,loadingFeedbackEl:I,loadingGeneratingEl:M}),ge=new $e({resultScreen:E,resultImageEl:z,resultSizeEl:V,resultConfidenceEl:_,resultFeedbackEl:B,resultStageEls:G}),x=new it(n,e),Le=new nt(n),le=new st(n);let J=null,X=null,Q=null,D=null,fe=null;const Be={header:s,headerEyebrow:o,headerTitle:r,headerSubtitle:a,modal:t,headerDefaults:d};Se("intro",Be);function N(c){t&&t.querySelectorAll(".bould-widget__screen").forEach(function(u){u.hidden=u.dataset.screen!==c}),Se(c,Be),c==="intro"?he.runAnimation():he.clearAnimation(),A.setGeneratingActive(c==="loading")}async function me(){return J||(J=(async()=>{try{const c=await le.fetchStatus();return x.applyPlanState(c),c}catch(c){return console.warn("[Bould Widget] Failed to determine plan status",c),x.applyPlanState(null),null}finally{J=null}})(),J)}function ot(){A.stopFeedbackCycle(!0),ge.reset(),X=null,Q=null,D=null,fe=null,I?(S&&(S.hidden=!0),I.hidden=!1,I.classList.remove("is-visible"),I.textContent="",X=A.startFeedback(ue,{loop:!0,holdMs:2600,fadeMs:600,initialDelay:0,hideStatus:!1}),Q=X?X.promise:null):A.reset(),N("loading")}async function at(){const c=_e(),u=le.getImmediateGate(c);if(u){x.showInline(u.message,u.tone||"warning"),u.blockButton&&x.setOpenButtonDisabled(!0,u.code||"immediate-gate",u.message),u.debug&&console.info("[Bould Widget] Immediate gate triggered",u.debug);return}x.setOpenButtonDisabled(!1);let w=null;try{w=await me()}catch{w=null}const h=le.getPreflightGate(w,c);if(h){x.showInline(h.message,h.tone||"warning"),h.blockButton?x.setOpenButtonDisabled(!0,h.code||"preflight-gate",h.message):x.setOpenButtonDisabled(!1),h.debug&&console.info("[Bould Widget] Preflight gate triggered",h.debug);return}x.clearInline(),x.setOpenButtonDisabled(!1),(!t.parentElement||t.parentElement!==document.body)&&document.body.appendChild(t),t.hidden=!1,t.setAttribute("data-state","opening");const b=Le.load();if(b){ge.reveal(b,N),A.reset(),setTimeout(function(){t.removeAttribute("data-state")},250);return}N("intro"),setTimeout(function(){t.removeAttribute("data-state")},250)}function pe(){t.hidden=!0,Ce.close(!0),A.stopFeedbackCycle(),A.reset(),he.clearAnimation()}function xe(c,u=null,w={}){const h=t.querySelector(".bould-widget__screen--error");if(!h)return;const b=h.querySelector("h3");b&&(b.textContent=w.heading||Re),P&&(w.action==="close"?(P.textContent=w.actionLabel||"Close",P.setAttribute("data-action","close")):(P.textContent=ke.label,P.setAttribute("data-action",ke.action)));const f=h.querySelector(".bould-widget__error");if(f){f.className="bould-widget__error",f.classList.add("bould-widget__error--danger"),w.tone==="info"?(f.classList.remove("bould-widget__error--danger"),f.classList.add("bould-widget__error--info")):w.tone==="warning"?(f.classList.remove("bould-widget__error--danger"),f.classList.add("bould-widget__error--warn")):w.tone==="error"&&f.classList.add("bould-widget__error--danger");const Y=[`<div class="bould-widget__error-content">${Ke(c)}</div>`],R=x.renderDebugInfo(u);R&&Y.push(R),f.innerHTML=Y.join("")}N("error")}e&&e.addEventListener("click",at),i&&i.addEventListener("click",pe),t&&t.addEventListener("click",function(c){c.target===t&&pe()}),t&&t.addEventListener("click",function(c){const u=c.target;u instanceof HTMLElement&&(u.matches('[data-action="continue"]')?N("form"):u.matches('[data-action="close"]')?pe():(u.matches('[data-action="back-to-form"]')||u.matches('[data-action="retake"]'))&&N("form"))}),z&&z.addEventListener("click",function(){const c=z.getAttribute("src");if(!c)return;const u=z.getAttribute("alt")||"Try on result";if(Ve()){Ce.open(c,u,z);return}const w=window.open(c,"_blank","noopener");if(w&&typeof w=="object")try{w.opener=null}catch{}else window.location.href=c});const q=n.querySelector(".bould-widget__form");if(q){let Y=function(){if(!c)return;const k=u?String(u.value||"").toLowerCase():"cm";k==="inch"||k==="inches"||k==="in"?f?(f.style.display="flex",c.style.display="none",c.required=!1,h&&(h.required=!0),b&&(b.required=!0)):(c.placeholder="Height (in)",c.min="25",c.max="107"):(f&&(f.style.display="none",h&&(h.required=!1),b&&(b.required=!1),c.style.display="block",c.required=!0),c.placeholder="Height (cm)",c.min="65",c.max="272")};const c=q.querySelector('input[name="height"]'),u=q.querySelector('select[name="body_unit"]'),w=c?c.parentElement:null;let h=null,b=null,f=null;if(u&&(u.style.appearance="none",u.style.backgroundImage=`url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 10 6' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L5 5L9 1' stroke='%236B7280' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E")`,u.style.backgroundRepeat="no-repeat",u.style.backgroundPosition="right 12px center",u.style.paddingRight="32px"),w){f=document.createElement("div"),f.className="bould-widget__imperial-inputs",f.style.display="none",f.style.gap="8px",f.style.width="100%",h=document.createElement("input"),h.type="number",h.placeholder="Ft",h.className=c.className,h.min="2",h.max="8",h.style.flex="1",h.required=!0,b=document.createElement("input"),b.type="number",b.placeholder="In",b.className=c.className,b.min="0",b.max="11",b.style.flex="1",b.required=!0,f.appendChild(h),f.appendChild(b),c.nextSibling?w.insertBefore(f,c.nextSibling):w.appendChild(f);const k=()=>{const j=parseInt(h.value)||0,U=parseInt(b.value)||0,ee=j*12+U;c.value=ee>0?ee:""};h.addEventListener("input",k),b.addEventListener("input",k)}Y(),u&&u.addEventListener("change",Y);const R=q.querySelector('input[name="user_image"]'),ce=q.querySelector(".bould-widget__upload-text"),Z=q.querySelector(".bould-widget__upload-icon");R&&R.addEventListener("change",function(){if(R.files&&R.files[0]){ce&&(ce.textContent=R.files[0].name,ce.style.color="#1E293B",ce.style.fontWeight="500"),Z&&(Z.innerHTML='<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>',Z.style.background="#E0E7FF",Z.style.color="#4F46E5",Z.style.transform="none");const k=q.querySelector(".bould-widget__file-upload");k&&(k.style.borderColor="#6366F1",k.style.background="#EEF2FF")}}),q.addEventListener("submit",async function(k){k.preventDefault();const j=new FormData(q),U=j.get("user_image"),ee=j.get("height"),Ie=j.get("body_unit"),Fe=typeof Ie=="string"?Ie.toLowerCase():"cm",be=tt(n);if(!(U instanceof File)||!ee)return xe("Missing image or height.");be&&j.set("product_image_url",be);let te=[],lt="",de="";ot();try{const g=K(n),H=Math.random().toString(36).slice(2,10),F=le.getEndpointBase(),W=g?`${F}?product_id=${encodeURIComponent(g)}`:F;console.log("[Bould Widget] Making request to:",W),console.log("[Bould Widget] Form data:",{hasImage:U instanceof File,imageSize:U instanceof File?U.size:"N/A",height:ee,imageType:U instanceof File?U.type:"N/A",bodyUnit:Fe,productId:g,correlationId:H,productImageUrl:be});const Te=new AbortController,ct=setTimeout(()=>Te.abort(),28e3),v=await fetch(W,{method:"POST",body:j,headers:{Accept:"application/json","X-Correlation-ID":H},signal:Te.signal}).finally(()=>clearTimeout(ct));console.log("[Bould Widget] Response status:",v.status);const ie=Object.fromEntries(v.headers.entries());if(console.log("[Bould Widget] Response headers:",ie),!v.ok){let p="Unknown server error",se={};if(!(v.headers.get("content-type")||"").includes("application/json")){const y=await v.text().catch(()=>"");p=`Server error: ${v.status}. Received non-JSON response. This often indicates a proxy misconfiguration.`;const T=new Error(p);throw T.debugInfo={correlationId:H,productId:g,responseCorrelationId:ie["x-correlation-id"]||ie["x-request-id"],hint:"Verify Shopify App Proxy path maps to /apps/bould",responseSnippet:y.slice(0,200)},T.statusCode=v.status,T}try{const y=await v.json();console.log("[Bould Widget] Error response data:",y),y.debug&&(se=y.debug,console.log("[Bould Widget] Debug info:",se)),v.status===404?p="Widget endpoint not found. Please check your configuration.":v.status===409?y.error&&(y.error.includes("not processed")||y.error.includes("not been converted"))?p="This garment hasn't been edited.":y.error&&y.error.includes("processing")?p="This garment is currently being processed. Please wait a few minutes and try again.":y.error&&y.error.includes("failed")?p="Garment conversion failed. Please try converting again in the Bould app.":p=y.error||"This garment hasn't been edited.":v.status===502?p="Garment processing service is unavailable. Please ensure the garment has been properly converted.":v.status===504?p="The request timed out. Please try again in a moment.":v.status===500?p=y.error||"Internal server error. Please try again later.":p=y.error||`Server error: ${v.status}`}catch(y){console.error("[Bould Widget] Failed to parse error response:",y),p=v.status===504?"The request timed out at the edge (504). Please try again.":`Server error: ${v.status} - Unable to parse error response`}const re=new Error(p);throw re.debugInfo=Object.assign({correlationId:H,productId:g,responseCorrelationId:ie["x-correlation-id"]||ie["x-request-id"]},se||{}),re.statusCode=v.status,re}const l=await v.json();console.log("[Bould Widget] Success response:",l);const dt=typeof l.display_unit=="string"?l.display_unit:Fe,qe=String(dt||"cm").toLowerCase()==="inch"?"inch":"cm",ut=l&&typeof l=="object"?l.match_details||l.matchDetails||{}:{};if(te=Array.isArray(l.preview_feedback)&&l.preview_feedback.length?l.preview_feedback:Ye(l,(S==null?void 0:S.dataset.defaultText)||"").slice(0,3),te.length,de=l.final_feedback||l.tailor_feedback||"",de||(de=te.join(" ").trim()),A.stopFeedbackCycle(!1),Q)try{await Q}catch(p){console.info("[Bould Widget] Default feedback sequence ended early",p)}X=null,Q=null;const ht=(te.length?te:[ue[ue.length-1]]).slice(0,3);if(D=A.startFeedback(ht,{loop:!0,holdMs:2800,fadeMs:600,initialDelay:0,hideStatus:!0}),fe=D?D.promise:null,l&&l.queued){if(!l.task_id)throw console.error("[Bould Widget] Queued response missing task_id:",l),new Error("The try-on service queued your request but did not provide a task ID. Please try again or contact support.");console.log("[Bould Widget] Try-on queued. Polling for completion. task_id=",l.task_id);const p=Date.now(),se=55e3,Ne=1500,re=l.task_id;let y=0;for(;Date.now()-p<se;){await new Promise(T=>setTimeout(T,Ne)),y+=1,console.log(`[Bould Widget] Polling attempt #${y}, elapsed: ${Date.now()-p}ms`);try{const T=`${F}?intent=tryon_status&task_id=${encodeURIComponent(re)}`;console.log("[Bould Widget] Polling URL:",T);const oe=await fetch(T,{headers:{Accept:"application/json","X-Correlation-ID":H}});if(console.log("[Bould Widget] Poll response status:",oe.status),oe.ok){const C=await oe.json();if(console.log("[Bould Widget] Poll response data:",C),C&&C.result_image_url){console.log("[Bould Widget] Try-on complete! Image URL:",C.result_image_url),l.tryOnImageUrl=C.result_image_url;break}if(C&&C.status){console.log("[Bould Widget] Try-on status:",C.status);const yt=String(C.status).toLowerCase();if(["fail","failed","error"].includes(yt)){const wt=C.error||"The try-on provider reported a failure.";throw new Error(`Try-on failed: ${wt}`)}}}else{const C=await oe.text().catch(()=>"");console.warn("[Bould Widget] Status poll failed",oe.status,C)}}catch(T){console.warn("[Bould Widget] Status poll error",T)}}if(!l.tryOnImageUrl)throw console.error("[Bould Widget] Polling timed out after",Date.now()-p,"ms"),new Error("The request timed out before the try-on image was ready. Please try again.")}if(!l||l.error)throw l.error&&l.error.includes("not processed")?new Error("This garment has not been converted yet. Please run conversion in the Bould app first."):new Error(l.error||"Invalid response from server.");const gt=l.recommended_size||l.recommendedSize||"",ft=String(gt||"").trim(),Me=qe==="inch"?"inches":"centimeters",mt="Recommended size: "+(ft||"-");let $="";if(l.confidence!==void 0&&l.confidence!==null&&l.confidence!==""){const p=Number(l.confidence);Number.isNaN(p)||($="Confidence: "+p.toFixed(2)+"%")}const Pe=Qe(ut,qe);$?$+=" • Measurements in "+Me:$="Measurements in "+Me,Pe&&($+=" • "+Pe);const ne=[];l.tryOnImageUrl&&ne.push(l.tryOnImageUrl),l.try_on_image_url&&l.try_on_image_url!==l.tryOnImageUrl&&ne.push(l.try_on_image_url),l.tryonImageUrl&&l.tryonImageUrl!==l.tryOnImageUrl&&ne.push(l.tryonImageUrl),l.debug&&l.debug.measurement_vis_url&&ne.push(l.debug.measurement_vis_url);const ye=await et(ne);if(D&&typeof D.cancel=="function"&&D.cancel(!0),D=null,fe=null,A.stopFeedbackCycle(!0),t.hidden){console.info("[Bould Widget] Modal closed before result reveal."),A.reset();return}const pt=ye&&ye.loaded?ye.url:"",bt=(de||"").trim()||S&&S.dataset.defaultText||"",De={imageUrl:pt,sizeText:mt,confidenceText:$,feedbackText:bt};Le.save(De),ge.reveal(De,N),A.reset()}catch(g){console.error("[Bould Widget] Error occurred:",g),A.reset();let H=g&&g.message?g.message:"Unknown error occurred. Please try again.";g&&g.name==="AbortError"&&(H="The request timed out before completing. Please try again in a moment.");let F=g&&g.debugInfo?{...g.debugInfo}:null;g&&g.statusCode&&(F||(F={}),F.statusCode=g.statusCode),F&&console.log("[Bould Widget] Debug information:",F);const W={};g&&g.statusCode===409?(W.tone="warning",W.heading="Action needed",W.action="close"):g&&g.statusCode&&g.statusCode>=500&&(W.tone="error"),xe(H,F,W),g&&g.statusCode===409&&me()}})}me()})})()})();
