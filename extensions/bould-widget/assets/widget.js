(function(){"use strict";const Pe="Something went wrong",De="Bould fit assistant",me={intro:{title:"Find your best fit",subtitle:"Upload a T-pose photo to unlock a personalized size recommendation.",compact:!1,describe:!0},loading:{title:"",subtitle:"",compact:!0,describe:!1},form:{compact:!0,ariaLabel:"Bould fit assistant form"},result:{compact:!0,ariaLabel:"Bould fit assistant result"},error:{compact:!0,ariaLabel:"Bould fit assistant error"}},Ue=2600,Re=600,Ne=220,ae=["Sizing assistant is reviewing your fit details...","Hang tight - preparing your personalized fit notes."],pe="Upgrade to continue using Bould.";function be(s,e){const{header:t,headerEyebrow:i,headerTitle:n,headerSubtitle:o,modal:r,headerDefaults:a}=e,c=me[s]||me.form||{},f=typeof c.eyebrow=="string"?c.eyebrow:"",p=typeof c.title=="string"?c.title:"",x=typeof c.subtitle=="string"?c.subtitle:"",M=!!c.describe;t&&t.classList.toggle("bould-widget__header--compact",!!c.compact),i&&(f?(i.hidden=!1,i.textContent=f):(i.hidden=!0,i.textContent=a.eyebrow)),n&&(p?(n.hidden=!1,n.textContent=p):(n.hidden=!0,n.textContent="")),o&&(x?(o.hidden=!1,o.textContent=x):(o.hidden=!0,o.textContent="")),r&&(p&&n&&!n.hidden?(r.setAttribute("aria-labelledby",n.id),r.removeAttribute("aria-label")):(r.removeAttribute("aria-labelledby"),r.setAttribute("aria-label",c.ariaLabel||De)),M&&o&&!o.hidden?r.setAttribute("aria-describedby",o.id):r.removeAttribute("aria-describedby"))}class He{constructor(e){this.introScreen=e.introScreen,this.introSteps=e.introSteps||[],this.introActions=e.introActions,this.animationTimers=[],this.heightLock={width:0,height:0},this.resizeObserver=null,this.init()}init(){typeof ResizeObserver=="function"&&this.introScreen&&(this.resizeObserver=new ResizeObserver(()=>{!this.introScreen||this.introScreen.hidden||this.lockHeight(!1)}),this.resizeObserver.observe(this.introScreen))}clearAnimation(){this.animationTimers.length&&(this.animationTimers.forEach(e=>clearTimeout(e)),this.animationTimers=[]),this.introSteps.length&&this.introSteps.forEach(e=>{e.classList.remove("is-visible","is-highlight"),e.setAttribute("aria-hidden","true"),e.style.opacity="0",e.style.visibility="hidden",e.style.transitionDelay="",e.classList.remove("is-active-intro"),this.setProgress(e,0)}),this.introActions&&(this.introActions.classList.remove("is-visible"),this.introActions.hidden=!0,this.introActions.setAttribute("hidden",""),this.introActions.setAttribute("aria-hidden","true")),this.introScreen&&(this.unlockHeight(),this.introScreen.classList.remove("is-animating")),this.heightLock={width:0,height:0}}queueTimeout(e,t){const i=setTimeout(e,Math.max(0,t));return this.animationTimers.push(i),i}setProgress(e,t){if(!e)return;const i=typeof t=="number"?t:parseFloat(t),n=Math.max(0,Math.min(1,Number.isFinite(i)?i:0));e.style.setProperty("--intro-progress",n.toFixed(3))}updateProgress(e){if(!this.introSteps.length)return;const t=typeof e=="number"?e:-1;this.introSteps.forEach((i,n)=>{let o=0;if(t>=0)if(n===t)o=1,i.classList.add("is-active-intro");else if(n<t){const r=t-n;r===1?o=.64:r===2?o=.44:o=.3,i.classList.remove("is-active-intro")}else o=0,i.classList.remove("is-active-intro");else i.classList.remove("is-active-intro");this.setProgress(i,o)})}measureNaturalHeight(){if(!this.introScreen)return 0;const e=this.introScreen.getBoundingClientRect(),t=this.introScreen.cloneNode(!0);t.style.position="absolute",t.style.top="-9999px",t.style.left="0",t.style.visibility="hidden",t.style.pointerEvents="none",t.style.opacity="0",t.style.transform="none",t.style.height="auto",t.style.minHeight="0",e&&e.width&&(t.style.width=Math.round(e.width)+"px"),t.classList.remove("is-animating"),t.querySelectorAll("[hidden]").forEach(r=>{r.hidden=!1,r.removeAttribute("hidden")}),t.querySelectorAll(".bould-widget__intro-step").forEach(r=>{r.classList.add("is-visible","is-active-intro"),r.classList.remove("is-highlight"),r.removeAttribute("style"),r.style.setProperty("--intro-progress","1")});const i=t.querySelector(".bould-widget__actions--intro");i&&(i.hidden=!1,i.removeAttribute("hidden"),i.classList.add("is-visible"),i.removeAttribute("style"),i.setAttribute("aria-hidden","false"));const n=this.introScreen.parentNode;if(!n)return 0;n.insertBefore(t,this.introScreen);const o=t.getBoundingClientRect();return n.removeChild(t),o&&o.height?Math.ceil(o.height):0}lockHeight(e){if(!this.introScreen)return;const t=this.introScreen.getBoundingClientRect(),i=t&&t.width?Math.round(t.width):0;if(i<=0){this.heightLock.height&&(this.introScreen.style.minHeight=this.heightLock.height+"px",this.introScreen.style.height=this.heightLock.height+"px");return}if(!e&&this.heightLock.height&&this.heightLock.width===i){this.introScreen.style.minHeight=this.heightLock.height+"px",this.introScreen.style.height=this.heightLock.height+"px";return}const n=this.measureNaturalHeight();n>0&&(this.heightLock={width:i,height:n},this.introScreen.style.minHeight=n+"px",this.introScreen.style.height=n+"px",this.introScreen.setAttribute("data-height-lock","true"))}unlockHeight(){this.introScreen&&(this.introScreen.style.height="",this.introScreen.style.minHeight="",this.introScreen.removeAttribute("data-height-lock"))}runAnimation(){if(!this.introScreen)return;if(this.clearAnimation(),this.lockHeight(!1),this.updateProgress(-1),!this.introSteps.length){this.introActions&&(this.introActions.hidden=!1,this.introActions.removeAttribute("hidden"),this.introActions.classList.add("is-visible"),this.introActions.setAttribute("aria-hidden","false")),this.unlockHeight();return}if(typeof window.matchMedia=="function"&&window.matchMedia("(prefers-reduced-motion: reduce)").matches){this.lockHeight(!0),this.introSteps.forEach(a=>{a.setAttribute("aria-hidden","false"),a.style.visibility="",a.style.opacity="",a.classList.add("is-visible"),this.setProgress(a,1),a.classList.add("is-active-intro")}),this.introActions&&(this.introActions.hidden=!1,this.introActions.removeAttribute("hidden"),this.introActions.classList.add("is-visible"),this.introActions.setAttribute("aria-hidden","false")),this.introScreen?(this.introScreen.classList.remove("is-animating"),requestAnimationFrame(()=>{this.unlockHeight()})):this.unlockHeight();return}this.introScreen.classList.add("is-animating");const t=220,i=1e3,n=620,o=360;this.lockHeight(!1);let r=t;this.introSteps.forEach((a,c)=>{this.queueTimeout(()=>{requestAnimationFrame(()=>{a.style.transitionDelay="0ms",a.setAttribute("aria-hidden","false"),a.style.visibility="",a.style.opacity="",a.classList.add("is-visible"),this.updateProgress(c)})},r),c===this.introSteps.length-1&&this.queueTimeout(()=>{this.introActions&&(this.introActions.hidden=!1,this.introActions.removeAttribute("hidden"),this.introActions.classList.add("is-visible"),this.introActions.setAttribute("aria-hidden","false")),this.introScreen?(this.introScreen.classList.remove("is-animating"),requestAnimationFrame(()=>{this.unlockHeight()})):this.unlockHeight()},r+n+o),r+=i})}}class ze{constructor(e){this.widgetId=e,this.viewer=null,this.image=null,this.frame=null,this.closeBtn=null,this.hideTimer=null,this.returnFocusEl=null,this.handleKeydown=this.handleKeydown.bind(this),this.init()}init(){this.viewer=this.createViewer(),this.viewer&&(this.image=this.viewer.querySelector(".bould-widget__image-viewer__img"),this.frame=this.viewer.querySelector(".bould-widget__image-viewer__frame"),this.closeBtn=this.viewer.querySelector(".bould-widget__image-viewer__close"),this.bindEvents())}createViewer(){if(typeof document>"u"||!document.body)return null;if(this.widgetId){const o=document.querySelectorAll(".bould-widget__image-viewer");for(let r=0;r<o.length;r+=1){const a=o[r];if(a&&a.getAttribute("data-widget-id")===this.widgetId)return a}}const e=document.createElement("div");e.className="bould-widget__image-viewer",this.widgetId&&e.setAttribute("data-widget-id",this.widgetId),e.hidden=!0,e.setAttribute("aria-hidden","true");const t=document.createElement("div");t.className="bould-widget__image-viewer__frame",t.setAttribute("role","dialog"),t.setAttribute("aria-modal","true"),t.setAttribute("aria-label","Result preview"),t.tabIndex=-1;const i=document.createElement("button");i.type="button",i.className="bould-widget__image-viewer__close",i.setAttribute("aria-label","Close result preview"),i.textContent="×";const n=document.createElement("img");return n.className="bould-widget__image-viewer__img",n.alt="Try on result preview",t.appendChild(i),t.appendChild(n),e.appendChild(t),document.body.appendChild(e),e}bindEvents(){this.viewer&&this.viewer.addEventListener("click",e=>{(!this.frame||e.target===this.viewer||!this.frame.contains(e.target))&&this.close()}),this.closeBtn&&this.closeBtn.addEventListener("click",e=>{e&&(e.preventDefault(),e.stopPropagation()),this.close()}),this.frame&&this.frame.addEventListener("click",e=>{e.stopPropagation()})}open(e,t,i){!this.viewer||!this.image||!e||(this.hideTimer&&(clearTimeout(this.hideTimer),this.hideTimer=null),this.returnFocusEl=i instanceof HTMLElement?i:null,this.image.src=e,this.image.alt=t||"Try on result",this.frame&&this.frame.setAttribute("aria-label",t?"Result preview: "+t:"Result preview"),this.viewer.hidden=!1,this.viewer.setAttribute("aria-hidden","false"),requestAnimationFrame(()=>{this.viewer.classList.add("is-visible")}),document.addEventListener("keydown",this.handleKeydown),this.closeBtn&&typeof this.closeBtn.focus=="function"&&setTimeout(()=>{try{this.closeBtn.focus({preventScroll:!0})}catch{this.closeBtn.focus()}},50))}close(e){if(!this.viewer||this.viewer.hidden)return;this.hideTimer&&(clearTimeout(this.hideTimer),this.hideTimer=null),this.viewer.classList.remove("is-visible"),document.removeEventListener("keydown",this.handleKeydown);const t=()=>{if(this.hideTimer=null,this.image&&this.image.removeAttribute("src"),this.viewer.setAttribute("aria-hidden","true"),this.viewer.hidden=!0,this.returnFocusEl&&typeof this.returnFocusEl.focus=="function")try{this.returnFocusEl.focus({preventScroll:!0})}catch{this.returnFocusEl.focus()}this.returnFocusEl=null};e?t():this.hideTimer=setTimeout(t,200)}handleKeydown(e){e&&(e.key==="Escape"||e.key==="Esc")&&(e.preventDefault(),this.close())}}class We{constructor(e){this.loadingScreen=e.loadingScreen,this.loadingStatusEl=e.loadingStatusEl,this.loadingFeedbackEl=e.loadingFeedbackEl,this.loadingGeneratingEl=e.loadingGeneratingEl,this.activeFeedbackCycle=null,this.defaultText=this.loadingStatusEl?this.loadingStatusEl.dataset.defaultText||this.loadingStatusEl.textContent:"",this.loadingStatusEl&&!this.loadingStatusEl.dataset.defaultText&&(this.loadingStatusEl.dataset.defaultText=this.defaultText)}setGeneratingActive(e){this.loadingGeneratingEl&&(e?(this.loadingGeneratingEl.hidden=!1,this.loadingGeneratingEl.removeAttribute("hidden"),this.loadingGeneratingEl.classList.add("is-active"),this.loadingGeneratingEl.setAttribute("aria-hidden","false")):(this.loadingGeneratingEl.classList.remove("is-active"),this.loadingGeneratingEl.setAttribute("aria-hidden","true"),this.loadingGeneratingEl.hidden=!0))}stopFeedbackCycle(e){this.activeFeedbackCycle&&typeof this.activeFeedbackCycle.cancel=="function"&&this.activeFeedbackCycle.cancel(!!e),this.activeFeedbackCycle=null}reset(){if(this.stopFeedbackCycle(!0),this.loadingStatusEl){this.loadingStatusEl.hidden=!1;const e=this.loadingStatusEl.dataset.defaultText||this.defaultText;e&&(this.loadingStatusEl.textContent=e)}this.loadingFeedbackEl&&(this.loadingFeedbackEl.hidden=!0,this.loadingFeedbackEl.classList.remove("is-visible"),this.loadingFeedbackEl.textContent=""),this.setGeneratingActive(!0)}startFeedback(e,t){const i=Array.isArray(e)?e.map(w=>typeof w=="string"?w.replace(/\s+/g," ").trim():"").filter(Boolean):[];if(!this.loadingFeedbackEl||!i.length){const w=i.length?i[i.length-1]:"";return{promise:Promise.resolve({finalMessage:w||"",cancelled:!1}),cancel:function(){}}}const n=Object.assign({loop:!1,holdMs:Ue,fadeMs:Re,finalHoldMs:Ne,initialDelay:30,hideStatus:!0,loopCount:null},t||{}),o=this.loadingFeedbackEl;n.hideStatus&&this.loadingStatusEl&&(this.loadingStatusEl.hidden=!0),o.hidden=!1,o.classList.remove("is-visible"),o.textContent="";let r=!1,a=null;const c=[],f=typeof n.loopCount=="number"&&n.loopCount>0?n.loopCount:null;let p=0;const x=()=>{for(;c.length;)clearTimeout(c.pop())},M=(w,L)=>{if(r)return;r=!0,x();const W=L!=null&&L!==""?L:o.textContent||i[i.length-1]||"";a&&a({finalMessage:W,cancelled:w})},_=w=>{if(r)return;if(!i.length){M(!0,"");return}const L=w%i.length,W=i[L];o.classList.remove("is-visible"),o.textContent=W,c.push(setTimeout(()=>{r||(o.classList.add("is-visible"),c.push(setTimeout(()=>{if(r)return;const G=L===i.length-1,re=(L+1)%i.length;if(n.loop){if(re===0&&(p+=1,f&&p>=f)){M(!1,W);return}o.classList.remove("is-visible"),c.push(setTimeout(()=>{r||_(re)},n.fadeMs))}else G?M(!1,W):(o.classList.remove("is-visible"),c.push(setTimeout(()=>{r||_(L+1)},n.fadeMs)))},n.holdMs)))},50))},J={promise:new Promise(w=>{a=w,c.push(setTimeout(()=>{_(0)},Math.max(0,n.initialDelay)))}).then(w=>(this.activeFeedbackCycle===J&&(this.activeFeedbackCycle=null),w)),cancel:w=>{if(r){w&&o.classList.remove("is-visible");return}w&&o.classList.remove("is-visible"),M(!0)}};return this.activeFeedbackCycle=J,J}}class Ge{constructor(e){this.resultScreen=e.resultScreen,this.resultImageEl=e.resultImageEl,this.resultSizeEl=e.resultSizeEl,this.resultConfidenceEl=e.resultConfidenceEl,this.resultFeedbackEl=e.resultFeedbackEl,this.resultStageEls=e.resultStageEls||[]}reset(){this.resultStageEls.forEach(e=>{e&&e.classList.remove("is-visible")}),this.resultImageEl&&(this.resultImageEl.removeAttribute("src"),this.resultImageEl.hidden=!1),this.resultSizeEl&&(this.resultSizeEl.textContent="",this.resultSizeEl.hidden=!1),this.resultConfidenceEl&&(this.resultConfidenceEl.textContent="",this.resultConfidenceEl.hidden=!1),this.resultFeedbackEl&&(this.resultFeedbackEl.textContent="",this.resultFeedbackEl.hidden=!1,this.resultFeedbackEl.classList.remove("is-visible"))}reveal(e,t){this.resultScreen&&(this.resultImageEl&&(e.imageUrl?(this.resultImageEl.hidden=!1,this.resultImageEl.src!==e.imageUrl&&(this.resultImageEl.src=e.imageUrl)):(this.resultImageEl.removeAttribute("src"),this.resultImageEl.hidden=!0)),this.resultSizeEl&&(e.sizeText?(this.resultSizeEl.textContent=e.sizeText,this.resultSizeEl.hidden=!1):(this.resultSizeEl.textContent="",this.resultSizeEl.hidden=!0)),this.resultConfidenceEl&&(e.confidenceText?(this.resultConfidenceEl.textContent=e.confidenceText,this.resultConfidenceEl.hidden=!1):(this.resultConfidenceEl.textContent="",this.resultConfidenceEl.hidden=!0)),this.resultFeedbackEl&&(e.feedbackText?(this.resultFeedbackEl.textContent=e.feedbackText,this.resultFeedbackEl.hidden=!1):(this.resultFeedbackEl.textContent="",this.resultFeedbackEl.hidden=!0),this.resultFeedbackEl.classList.remove("is-visible")),typeof t=="function"&&t("result"),requestAnimationFrame(()=>{requestAnimationFrame(()=>{this.resultStageEls.forEach(i=>{if(i){if(i===this.resultImageEl&&!e.imageUrl){i.classList.remove("is-visible");return}i.classList.add("is-visible")}}),this.resultFeedbackEl&&this.resultFeedbackEl.classList.contains("bould-widget__fade-text")&&e.feedbackText&&this.resultFeedbackEl.classList.add("is-visible")})}))}}function C(s){return String(s??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function Oe(s){return C(s).replace(/\r?\n/g,"<br />")}function ye(){try{return!!(window.Shopify&&window.Shopify.designMode)}catch{return!1}}function je(){try{if(navigator!=null&&navigator.userAgentData&&typeof navigator.userAgentData.mobile=="boolean")return navigator.userAgentData.mobile}catch{}const s=(navigator.userAgent||navigator.vendor||window.opera&&window.opera.toString&&window.opera.toString()||"").toLowerCase(),e=/(android|iphone|ipad|ipod|windows phone|blackberry|bb10|mobile)/i.test(s),t=typeof window.matchMedia=="function"&&window.matchMedia("(pointer: coarse)").matches,i=typeof window.matchMedia=="function"&&window.matchMedia("(max-width: 820px)").matches;return e||t&&i}function $e(s){if(!s)return[];const e=String(s).replace(/\s+/g," ").match(/[^.!?]+[.!?]*/g);return e?e.map(function(t){return t.trim()}).filter(Boolean):[String(s).trim()]}function Ke(s){return String(s||"").split("_").map(function(e){return e?e.charAt(0).toUpperCase()+e.slice(1):""}).filter(Boolean).join(" ")}function Ve(s,e){if(!s||typeof s!="object")return"";const i=s[e==="inch"?"slacks_in":"slacks_cm"];if(!i||typeof i!="object")return"";const n=Object.entries(i).map(function(a){const c=a[0],f=Number(a[1]);return!c||Number.isNaN(f)?null:[c,f]}).filter(Boolean).sort(function(a,c){return Math.abs(c[1])-Math.abs(a[1])});if(!n.length)return"";const o=n.slice(0,3).map(function(a){const c=Ke(a[0]),f=a[1],p=(f>0?"+":"")+f.toFixed(1);return c+" "+p});return"Slack ("+(e==="inch"?"in":"cm")+"): "+o.join(", ")}function Je(s,e=""){if(!s||typeof s!="object")return["We're reviewing your fit details...","Hang tight - we're rendering your try-on preview now."];const t=s.tailor_feedback_sequence||s.tailor_feedbacks||s.tailorFeedbackSequence||s.tailorFeedbacks||s.tailor_feedback||s.tailorFeedback;let i=[];if(Array.isArray(t)?i=t:t&&typeof t=="object"&&Array.isArray(t.messages)?i=t.messages:t!=null&&(i=[t]),i=i.map(function(r){return String(r||"").replace(/\s+/g," ").trim()}).filter(Boolean),!i.length&&e&&(i=[e]),i.length===1){const r=i[0],a=r.split(/\n+/).map(function(c){return c.replace(/\s+/g," ").trim()}).filter(Boolean);if(a.length>=2)i=[a[0],a.slice(1).join(" ").trim()];else{const c=$e(r);if(c.length>=2){const f=c.slice(1).join(" ").trim();f&&(i=[c[0],f])}}}const n=new Set,o=[];return i.forEach(function(r){n.has(r)||(n.add(r),o.push(r))}),o.length||o.push("We're reviewing your fit details..."),o.length===1&&o.push("Hang tight - we're rendering your try-on preview now."),o.slice(0,3)}function Xe(s){return s?new Promise(function(e){const t=new Image;t.decoding="async",t.onload=function(){e({url:s,loaded:!0})},t.onerror=function(){e({url:s,loaded:!1})},t.src=s}):Promise.resolve({url:"",loaded:!1})}function Qe(s){const e=Array.isArray(s)?s.filter(Boolean):[];if(!e.length)return Promise.resolve({url:"",loaded:!1});let t=0;return new Promise(function(i){function n(){const o=e[t];Xe(o).then(function(r){if(r.loaded){i(r);return}if(t<e.length-1){console.warn("[Bould Widget] Try-on image failed to load, trying next candidate",o),t+=1,n();return}i({url:o,loaded:!1})})}n()})}function V(s){const e=s.getAttribute("data-product-id")||"";if(e)return e;try{const t=window.ShopifyAnalytics&&window.ShopifyAnalytics.meta&&window.ShopifyAnalytics.meta.product&&window.ShopifyAnalytics.meta.product.id||null;if(t)return`gid://shopify/Product/${t}`}catch{}return""}function Ye(s){const e=s.getAttribute("data-product-image")||"";if(e)return e;try{const t=window.ShopifyAnalytics&&window.ShopifyAnalytics.meta&&window.ShopifyAnalytics.meta.product;if(t){if(typeof t.image_url=="string"&&t.image_url)return t.image_url;if(Array.isArray(t.images)&&t.images.length>0)return t.images[0]}}catch{}return""}function we(){try{const s=window.Shopify&&window.Shopify.customer;if(s&&(s.id||s.email))return!0}catch{}try{const s=window.ShopifyAnalytics&&window.ShopifyAnalytics.meta;if(s&&(s.page&&s.page.customerId||s.customerId))return!0}catch{}try{const s=document.cookie?document.cookie.split(";"):[];for(let e=0;e<s.length;e+=1){const t=s[e].trim();if(!t)continue;const i=t.indexOf("=");if(i===-1)continue;const n=t.slice(0,i),o=t.slice(i+1);if(n==="customer_signed_in"){const r=o.toLowerCase();if(r==="true"||r==="1"||r==="yes")return!0}}}catch{}return!1}class Ze{constructor(e,t){this.container=e,this.openBtn=t}ensureStateNotice(){let e=this.container.querySelector(".bould-widget__state");return e||(e=document.createElement("div"),e.className="bould-widget__state",e.hidden=!0,this.openBtn&&typeof this.openBtn.insertAdjacentElement=="function"?this.openBtn.insertAdjacentElement("afterend",e):this.container.appendChild(e)),e}showInline(e,t){const i=this.ensureStateNotice();i.className="bould-widget__state",t==="warning"?i.classList.add("bould-widget__state--warning"):t==="error"&&i.classList.add("bould-widget__state--error"),i.innerHTML=`<p>${C(e)}</p>`,i.hidden=!1}clearInline(){const e=this.container.querySelector(".bould-widget__state");e&&(e.className="bould-widget__state",e.innerHTML="",e.hidden=!0)}ensureUpgradeNotice(){let e=this.container.querySelector(".bould-widget__upgrade");return e||(e=document.createElement("div"),e.className="bould-widget__upgrade",this.container.appendChild(e)),e}applyPlanState(e){const t=e&&e.plan?e.plan:null,i=!!(t&&t.blocked),n=this.container.querySelector(".bould-widget__upgrade"),o=!!(window.Shopify&&window.Shopify.designMode);if(i){const r=t&&t.message?t.message:pe;if(o){const a=n||this.ensureUpgradeNotice();a.textContent=r,a.hidden=!1}else n&&(n.textContent="",n.hidden=!0);this.container.setAttribute("data-plan-blocked","true"),this.openBtn&&(this.openBtn.disabled=!0,this.openBtn.classList.add("bould-widget__open--disabled"),this.openBtn.style.display=o?"":"none",this.openBtn.setAttribute("data-disabled-reason","plan-blocked"),this.openBtn.setAttribute("title",r),this.openBtn.setAttribute("aria-disabled","true"))}else this.container.removeAttribute("data-plan-blocked"),n&&(n.textContent="",n.hidden=!0),this.openBtn&&(this.openBtn.style.display="",this.openBtn.disabled=!1,this.openBtn.classList.remove("bould-widget__open--disabled"),this.openBtn.removeAttribute("data-disabled-reason"),this.openBtn.removeAttribute("title"),this.openBtn.removeAttribute("aria-disabled"))}setOpenButtonDisabled(e,t,i){this.openBtn&&(!e&&this.container.getAttribute("data-plan-blocked")==="true"||(e?(this.openBtn.disabled=!0,this.openBtn.classList.add("bould-widget__open--disabled"),this.openBtn.setAttribute("aria-disabled","true"),t&&this.openBtn.setAttribute("data-disabled-reason",t),i&&this.openBtn.setAttribute("title",i)):(this.openBtn.disabled=!1,this.openBtn.classList.remove("bould-widget__open--disabled"),this.openBtn.removeAttribute("aria-disabled"),(!t||this.openBtn.getAttribute("data-disabled-reason")===t)&&this.openBtn.removeAttribute("data-disabled-reason"),(!i||this.openBtn.getAttribute("title")===i)&&this.openBtn.removeAttribute("title"))))}renderDebugInfo(e){if(!e)return"";const t=[];return e.requestId&&t.push(`Request ID: ${C(e.requestId)}`),e.productId&&t.push(`Product ID: ${C(e.productId)}`),e.conversionStatus&&t.push(`Conversion Status: ${C(e.conversionStatus)}`),e.statusCode&&t.push(`Status Code: ${C(e.statusCode)}`),e.timestamp&&t.push(`Timestamp: ${C(e.timestamp)}`),e.suggestion&&t.push(`Suggestion: ${C(e.suggestion)}`),e.reason&&t.push(`Reason: ${C(e.reason)}`),e.correlationId&&t.push(`Correlation ID: ${C(e.correlationId)}`),e.responseCorrelationId&&t.push(`Response ID: ${C(e.responseCorrelationId)}`),t.length?`<div class="bould-widget__debug-info"><strong>Debug Information:</strong><br>${t.join("<br>")}</div>`:""}}class et{constructor(e){this.container=e}getStorageKey(){const e=V(this.container);return"bould_result_"+(e?e.replace(/\W/g,"_"):"default")}save(e){if(we())try{const t=this.getStorageKey();localStorage.setItem(t,JSON.stringify({details:e,timestamp:Date.now()}))}catch(t){console.warn("[Bould Widget] Failed to save result to storage",t)}}load(){if(!we())return null;try{const e=this.getStorageKey(),t=localStorage.getItem(e);return t?JSON.parse(t).details:null}catch(e){return console.warn("[Bould Widget] Failed to load result from storage",e),null}}}class tt{constructor(e){this.container=e}getEndpointBase(){const e=this.container.getAttribute("data-api-base");return e&&e!=="use_app_route"&&e!=="use_app_proxy"?e:"/apps/bould"}async fetchStatus(){const e=V(this.container),t=ye();if(!e&&!t)return null;const i=Math.random().toString(36).slice(2,10),n=new URLSearchParams;n.set("intent","status"),e&&n.set("product_id",e),t&&n.set("design_mode","1");const o=`${this.getEndpointBase()}?${n.toString()}`,r=await fetch(o,{headers:{Accept:"application/json","X-Correlation-ID":i}});if(!r.ok){const a=await r.text().catch(()=>"");return console.warn("[Bould Widget] Status check failed",r.status,a),null}return r.json()}getImmediateGate(e){return null}getPreflightGate(e,t){var i,n;if(!e)return null;if(e.plan&&e.plan.blocked)return{heading:"Upgrade required",message:e.plan.message||pe,tone:"warning",action:"close",blockButton:!0,code:"plan-blocked",debug:{requestId:(i=e==null?void 0:e.debug)==null?void 0:i.requestId,planId:e.plan.id,productId:e.productId||V(this.container),reason:"plan_blocked"}};if(!t&&e.isProcessed===!1){const o=e.conversionStatus||"not_ready";let r="Garment isn't ready yet",a="This garment has not been processed yet.",c="warning";return o==="processing"?(r="Garment still processing",a="We are still processing this garment. Please wait a few minutes and try again."):o==="failed"&&(r="Garment conversion failed",a="This garment is not available for try-on.",c="error"),{heading:r,message:a,tone:c,action:"close",blockButton:!1,code:"garment-unprocessed",debug:{requestId:(n=e==null?void 0:e.debug)==null?void 0:n.requestId,productId:e.productId||V(this.container),conversionStatus:o,reason:"garment_unprocessed"}}}return null}}(function(){document.querySelectorAll("[data-bould-widget]").forEach(function(s){const e=s.querySelector(".bould-widget__open"),t=s.querySelector(".bould-widget"),i=s.querySelector(".bould-widget__close"),n=t?t.querySelector(".bould-widget__header"):null,o=n?n.querySelector(".bould-widget__eyebrow"):null,r=n?n.querySelector(".bould-widget__title"):null,a=n?n.querySelector(".bould-widget__subtitle"):null,c={eyebrow:o?o.textContent.trim():"",title:r?r.textContent.trim():"",subtitle:a?a.textContent.trim():""},f=t?t.querySelector(".bould-widget__screen--loading"):null,p=f?f.querySelector(".bould-widget__loading-text"):null,x=f?f.querySelector("[data-loading-feedback]"):null,M=f?f.querySelector("[data-loading-generating]"):null,_=t?t.querySelector(".bould-widget__screen--result"):null,z=_?_.querySelector(".bould-widget__result-image"):null,J=_?_.querySelector(".bould-widget__size"):null,w=_?_.querySelector(".bould-widget__confidence"):null,L=_?_.querySelector(".bould-widget__feedback"):null,W=_?Array.from(_.querySelectorAll(".bould-widget__result-stage")):[],G=t?t.querySelector(".bould-widget__screen--intro"):null,re=G?Array.from(G.querySelectorAll(".bould-widget__intro-step")):[],ve=G?G.querySelector(".bould-widget__actions--intro"):null,P=t?t.querySelector(".bould-widget__screen--error [data-action]"):null,Se=P?{label:P.textContent||"Try again",action:P.getAttribute("data-action")||"back-to-form"}:{label:"Try again",action:"back-to-form"};s&&s.classList&&!s.classList.contains("bould-widget--enhanced")&&s.classList.add("bould-widget--enhanced");const it=s.getAttribute("data-block-id")||""||Math.random().toString(36).slice(2,8),le=new He({introScreen:G,introSteps:re,introActions:ve}),_e=new ze(it),E=new We({loadingScreen:f,loadingStatusEl:p,loadingFeedbackEl:x,loadingGeneratingEl:M}),ce=new Ge({resultScreen:_,resultImageEl:z,resultSizeEl:J,resultConfidenceEl:w,resultFeedbackEl:L,resultStageEls:W}),B=new Ze(s,e),Ee=new et(s),oe=new tt(s);let X=null,Q=null,Y=null,D=null,de=null;const Ae={header:n,headerEyebrow:o,headerTitle:r,headerSubtitle:a,modal:t,headerDefaults:c};be("intro",Ae);function U(d){t&&t.querySelectorAll(".bould-widget__screen").forEach(function(u){u.hidden=u.dataset.screen!==d}),be(d,Ae),d==="intro"?le.runAnimation():le.clearAnimation(),E.setGeneratingActive(d==="loading")}async function ue(){return X||(X=(async()=>{try{const d=await oe.fetchStatus();return B.applyPlanState(d),d}catch(d){return console.warn("[Bould Widget] Failed to determine plan status",d),B.applyPlanState(null),null}finally{X=null}})(),X)}function st(){E.stopFeedbackCycle(!0),ce.reset(),Q=null,Y=null,D=null,de=null,x?(p&&(p.hidden=!0),x.hidden=!1,x.classList.remove("is-visible"),x.textContent="",Q=E.startFeedback(ae,{loop:!0,holdMs:2600,fadeMs:600,initialDelay:0,hideStatus:!1}),Y=Q?Q.promise:null):E.reset(),U("loading")}async function nt(){const d=ye(),u=oe.getImmediateGate(d);if(u){B.showInline(u.message,u.tone||"warning"),u.blockButton&&B.setOpenButtonDisabled(!0,u.code||"immediate-gate",u.message),u.debug&&console.info("[Bould Widget] Immediate gate triggered",u.debug);return}B.setOpenButtonDisabled(!1);let v=null;try{v=await ue()}catch{v=null}const b=oe.getPreflightGate(v,d);if(b){B.showInline(b.message,b.tone||"warning"),b.blockButton?B.setOpenButtonDisabled(!0,b.code||"preflight-gate",b.message):B.setOpenButtonDisabled(!1),b.debug&&console.info("[Bould Widget] Preflight gate triggered",b.debug);return}B.clearInline(),B.setOpenButtonDisabled(!1),(!t.parentElement||t.parentElement!==document.body)&&document.body.appendChild(t),t.hidden=!1,t.setAttribute("data-state","opening");const F=Ee.load();if(F){ce.reveal(F,U),E.reset(),setTimeout(function(){t.removeAttribute("data-state")},250);return}U("intro"),setTimeout(function(){t.removeAttribute("data-state")},250)}function he(){t.hidden=!0,_e.close(!0),E.stopFeedbackCycle(),E.reset(),le.clearAnimation()}function ke(d,u=null,v={}){const b=t.querySelector(".bould-widget__screen--error");if(!b)return;const F=b.querySelector("h3");F&&(F.textContent=v.heading||Pe),P&&(v.action==="close"?(P.textContent=v.actionLabel||"Close",P.setAttribute("data-action","close")):(P.textContent=Se.label,P.setAttribute("data-action",Se.action)));const S=b.querySelector(".bould-widget__error");if(S){S.className="bould-widget__error",S.classList.add("bould-widget__error--danger"),v.tone==="info"?(S.classList.remove("bould-widget__error--danger"),S.classList.add("bould-widget__error--info")):v.tone==="warning"?(S.classList.remove("bould-widget__error--danger"),S.classList.add("bould-widget__error--warn")):v.tone==="error"&&S.classList.add("bould-widget__error--danger");const A=[`<div class="bould-widget__error-content">${Oe(d)}</div>`],R=B.renderDebugInfo(u);R&&A.push(R),S.innerHTML=A.join("")}U("error")}e&&e.addEventListener("click",nt),i&&i.addEventListener("click",he),t&&t.addEventListener("click",function(d){d.target===t&&he()}),t&&t.addEventListener("click",function(d){const u=d.target;u instanceof HTMLElement&&(u.matches('[data-action="continue"]')?U("form"):u.matches('[data-action="close"]')?he():(u.matches('[data-action="back-to-form"]')||u.matches('[data-action="retake"]'))&&U("form"))}),z&&z.addEventListener("click",function(){const d=z.getAttribute("src");if(!d)return;const u=z.getAttribute("alt")||"Try on result";if(je()){_e.open(d,u,z);return}const v=window.open(d,"_blank","noopener");if(v&&typeof v=="object")try{v.opener=null}catch{}else window.location.href=d});const q=s.querySelector(".bould-widget__form");if(q){let v=function(){if(!d)return;const A=u?String(u.value||"").toLowerCase():"cm";A==="inch"||A==="inches"||A==="in"?(d.placeholder="Height (in)",d.min="31",d.max="99"):(d.placeholder="Height (cm)",d.min="80",d.max="250")};const d=q.querySelector('input[name="height"]'),u=q.querySelector('select[name="body_unit"]');v(),u&&u.addEventListener("change",v);const b=q.querySelector('input[name="user_image"]'),F=q.querySelector(".bould-widget__upload-text"),S=q.querySelector(".bould-widget__upload-icon");b&&b.addEventListener("change",function(){if(b.files&&b.files[0]){F&&(F.textContent=b.files[0].name,F.style.color="#1E293B",F.style.fontWeight="500"),S&&(S.innerHTML='<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>',S.style.background="#E0E7FF",S.style.color="#4F46E5",S.style.transform="none");const A=q.querySelector(".bould-widget__file-upload");A&&(A.style.borderColor="#6366F1",A.style.background="#EEF2FF")}}),q.addEventListener("submit",async function(A){A.preventDefault();const R=new FormData(q),j=R.get("user_image"),Ce=R.get("height"),Le=R.get("body_unit"),Be=typeof Le=="string"?Le.toLowerCase():"cm",fe=Ye(s);if(!(j instanceof File)||!Ce)return ke("Missing image or height.");fe&&R.set("product_image_url",fe);let O=[],$="",Z="";st();try{const h=V(s),N=Math.random().toString(36).slice(2,10),T=oe.getEndpointBase(),H=h?`${T}?product_id=${encodeURIComponent(h)}`:T;console.log("[Bould Widget] Making request to:",H),console.log("[Bould Widget] Form data:",{hasImage:j instanceof File,imageSize:j instanceof File?j.size:"N/A",height:Ce,imageType:j instanceof File?j.type:"N/A",bodyUnit:Be,productId:h,correlationId:N,productImageUrl:fe});const xe=new AbortController,rt=setTimeout(()=>xe.abort(),28e3),y=await fetch(H,{method:"POST",body:R,headers:{Accept:"application/json","X-Correlation-ID":N},signal:xe.signal}).finally(()=>clearTimeout(rt));console.log("[Bould Widget] Response status:",y.status);const ee=Object.fromEntries(y.headers.entries());if(console.log("[Bould Widget] Response headers:",ee),!y.ok){let g="Unknown server error",ie={};if(!(y.headers.get("content-type")||"").includes("application/json")){const m=await y.text().catch(()=>"");g=`Server error: ${y.status}. Received non-JSON response. This often indicates a proxy misconfiguration.`;const I=new Error(g);throw I.debugInfo={correlationId:N,productId:h,responseCorrelationId:ee["x-correlation-id"]||ee["x-request-id"],hint:"Verify Shopify App Proxy path maps to /apps/bould",responseSnippet:m.slice(0,200)},I.statusCode=y.status,I}try{const m=await y.json();console.log("[Bould Widget] Error response data:",m),m.debug&&(ie=m.debug,console.log("[Bould Widget] Debug info:",ie)),y.status===404?g="Widget endpoint not found. Please check your configuration.":y.status===409?m.error&&(m.error.includes("not processed")||m.error.includes("not been converted"))?g="This garment hasn't been edited.":m.error&&m.error.includes("processing")?g="This garment is currently being processed. Please wait a few minutes and try again.":m.error&&m.error.includes("failed")?g="Garment conversion failed. Please try converting again in the Bould app.":g=m.error||"This garment hasn't been edited.":y.status===502?g="Garment processing service is unavailable. Please ensure the garment has been properly converted.":y.status===504?g="The request timed out. Please try again in a moment.":y.status===500?g=m.error||"Internal server error. Please try again later.":g=m.error||`Server error: ${y.status}`}catch(m){console.error("[Bould Widget] Failed to parse error response:",m),g=y.status===504?"The request timed out at the edge (504). Please try again.":`Server error: ${y.status} - Unable to parse error response`}const se=new Error(g);throw se.debugInfo=Object.assign({correlationId:N,productId:h,responseCorrelationId:ee["x-correlation-id"]||ee["x-request-id"]},ie||{}),se.statusCode=y.status,se}const l=await y.json();console.log("[Bould Widget] Success response:",l);const ot=typeof l.display_unit=="string"?l.display_unit:Be,Fe=String(ot||"cm").toLowerCase()==="inch"?"inch":"cm",at=l&&typeof l=="object"?l.match_details||l.matchDetails||{}:{};if(O=Je(l,(p==null?void 0:p.dataset.defaultText)||"").slice(0,3),!O.length&&$&&(O=[$]),$=O[0]||$||"",Z=O.join(" ").trim(),Z||(Z=$||p&&p.dataset.defaultText||""),E.stopFeedbackCycle(!1),Y)try{await Y}catch(g){console.info("[Bould Widget] Default feedback sequence ended early",g)}Q=null,Y=null;const lt=(O.length?O:[Z||$||ae[ae.length-1]]).slice(0,3);if(D=E.startFeedback(lt,{loop:!0,holdMs:2800,fadeMs:600,initialDelay:0,hideStatus:!0}),de=D?D.promise:null,l&&l.queued){if(!l.task_id)throw console.error("[Bould Widget] Queued response missing task_id:",l),new Error("The try-on service queued your request but did not provide a task ID. Please try again or contact support.");console.log("[Bould Widget] Try-on queued. Polling for completion. task_id=",l.task_id);const g=Date.now(),ie=55e3,Me=1500,se=l.task_id;let m=0;for(;Date.now()-g<ie;){await new Promise(I=>setTimeout(I,Me)),m+=1,console.log(`[Bould Widget] Polling attempt #${m}, elapsed: ${Date.now()-g}ms`);try{const I=`${T}?intent=tryon_status&task_id=${encodeURIComponent(se)}`;console.log("[Bould Widget] Polling URL:",I);const ne=await fetch(I,{headers:{Accept:"application/json","X-Correlation-ID":N}});if(console.log("[Bould Widget] Poll response status:",ne.status),ne.ok){const k=await ne.json();if(console.log("[Bould Widget] Poll response data:",k),k&&k.result_image_url){console.log("[Bould Widget] Try-on complete! Image URL:",k.result_image_url),l.tryOnImageUrl=k.result_image_url;break}if(k&&k.status){console.log("[Bould Widget] Try-on status:",k.status);const gt=String(k.status).toLowerCase();if(["fail","failed","error"].includes(gt)){const mt=k.error||"The try-on provider reported a failure.";throw new Error(`Try-on failed: ${mt}`)}}}else{const k=await ne.text().catch(()=>"");console.warn("[Bould Widget] Status poll failed",ne.status,k)}}catch(I){console.warn("[Bould Widget] Status poll error",I)}}if(!l.tryOnImageUrl)throw console.error("[Bould Widget] Polling timed out after",Date.now()-g,"ms"),new Error("The request timed out before the try-on image was ready. Please try again.")}if(!l||l.error)throw l.error&&l.error.includes("not processed")?new Error("This garment has not been converted yet. Please run conversion in the Bould app first."):new Error(l.error||"Invalid response from server.");const ct=l.recommended_size||l.recommendedSize||"",dt=String(ct||"").trim(),Te=Fe==="inch"?"inches":"centimeters",ut="Recommended size: "+(dt||"-");let K="";if(l.confidence!==void 0&&l.confidence!==null&&l.confidence!==""){const g=Number(l.confidence);Number.isNaN(g)||(K="Confidence: "+g.toFixed(2)+"%")}const Ie=Ve(at,Fe);K?K+=" • Measurements in "+Te:K="Measurements in "+Te,Ie&&(K+=" • "+Ie);const te=[];l.tryOnImageUrl&&te.push(l.tryOnImageUrl),l.try_on_image_url&&l.try_on_image_url!==l.tryOnImageUrl&&te.push(l.try_on_image_url),l.tryonImageUrl&&l.tryonImageUrl!==l.tryOnImageUrl&&te.push(l.tryonImageUrl),l.debug&&l.debug.measurement_vis_url&&te.push(l.debug.measurement_vis_url);const ge=await Qe(te);if(D&&typeof D.cancel=="function"&&D.cancel(!0),D=null,de=null,E.stopFeedbackCycle(!0),t.hidden){console.info("[Bould Widget] Modal closed before result reveal."),E.reset();return}const ht=ge&&ge.loaded?ge.url:"",ft=l.final_feedback||l.finalFeedback||(Z||"").trim()||p&&p.dataset.defaultText||"",qe={imageUrl:ht,sizeText:ut,confidenceText:K,feedbackText:ft};Ee.save(qe),ce.reveal(qe,U),E.reset()}catch(h){console.error("[Bould Widget] Error occurred:",h),E.reset();let N=h&&h.message?h.message:"Unknown error occurred. Please try again.";h&&h.name==="AbortError"&&(N="The request timed out before completing. Please try again in a moment.");let T=h&&h.debugInfo?{...h.debugInfo}:null;h&&h.statusCode&&(T||(T={}),T.statusCode=h.statusCode),T&&console.log("[Bould Widget] Debug information:",T);const H={};h&&h.statusCode===409?(H.tone="warning",H.heading="Action needed",H.action="close"):h&&h.statusCode&&h.statusCode>=500&&(H.tone="error"),ke(N,T,H),h&&h.statusCode===409&&ue()}})}ue()})})()})();
