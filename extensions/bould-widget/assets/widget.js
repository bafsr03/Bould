(function(){"use strict";const Pe="Something went wrong",Ue="Bould fit assistant",ve={intro:{title:"Find your best fit",subtitle:"Upload a T-pose photo to unlock a personalized size recommendation.",compact:!1,describe:!0},loading:{title:"",subtitle:"",compact:!0,describe:!1},form:{compact:!0,ariaLabel:"Bould fit assistant form"},result:{compact:!0,ariaLabel:"Bould fit assistant result"},error:{compact:!0,ariaLabel:"Bould fit assistant error"}},ze=2600,Re=600,Oe=220,fe=["Sizing assistant is reviewing your fit details...","Hang tight - preparing your personalized fit notes."],Se="Upgrade to continue using Bould.";function _e(n,e){const{header:t,headerEyebrow:i,headerTitle:s,headerSubtitle:o,modal:r,headerDefaults:l}=e,d=ve[n]||ve.form||{},w=typeof d.eyebrow=="string"?d.eyebrow:"",S=typeof d.title=="string"?d.title:"",x=typeof d.subtitle=="string"?d.subtitle:"",F=!!d.describe;t&&t.classList.toggle("bould-widget__header--compact",!!d.compact),i&&(w?(i.hidden=!1,i.textContent=w):(i.hidden=!0,i.textContent=l.eyebrow)),s&&(S?(s.hidden=!1,s.textContent=S):(s.hidden=!0,s.textContent="")),o&&(x?(o.hidden=!1,o.textContent=x):(o.hidden=!0,o.textContent="")),r&&(S&&s&&!s.hidden?(r.setAttribute("aria-labelledby",s.id),r.removeAttribute("aria-label")):(r.removeAttribute("aria-labelledby"),r.setAttribute("aria-label",d.ariaLabel||Ue)),F&&o&&!o.hidden?r.setAttribute("aria-describedby",o.id):r.removeAttribute("aria-describedby"))}class We{constructor(e){this.introScreen=e.introScreen,this.introSteps=e.introSteps||[],this.introActions=e.introActions,this.animationTimers=[],this.heightLock={width:0,height:0},this.resizeObserver=null,this.init()}init(){typeof ResizeObserver=="function"&&this.introScreen&&(this.resizeObserver=new ResizeObserver(()=>{!this.introScreen||this.introScreen.hidden||this.lockHeight(!1)}),this.resizeObserver.observe(this.introScreen))}clearAnimation(){this.animationTimers.length&&(this.animationTimers.forEach(e=>clearTimeout(e)),this.animationTimers=[]),this.introSteps.length&&this.introSteps.forEach(e=>{e.classList.remove("is-visible","is-highlight"),e.setAttribute("aria-hidden","true"),e.style.opacity="0",e.style.visibility="hidden",e.style.transitionDelay="",e.classList.remove("is-active-intro"),this.setProgress(e,0)}),this.introActions&&(this.introActions.classList.remove("is-visible"),this.introActions.hidden=!0,this.introActions.setAttribute("hidden",""),this.introActions.setAttribute("aria-hidden","true")),this.introScreen&&(this.unlockHeight(),this.introScreen.classList.remove("is-animating")),this.heightLock={width:0,height:0}}queueTimeout(e,t){const i=setTimeout(e,Math.max(0,t));return this.animationTimers.push(i),i}setProgress(e,t){if(!e)return;const i=typeof t=="number"?t:parseFloat(t),s=Math.max(0,Math.min(1,Number.isFinite(i)?i:0));e.style.setProperty("--intro-progress",s.toFixed(3))}updateProgress(e){if(!this.introSteps.length)return;const t=typeof e=="number"?e:-1;this.introSteps.forEach((i,s)=>{let o=0;if(t>=0)if(s===t)o=1,i.classList.add("is-active-intro");else if(s<t){const r=t-s;r===1?o=.64:r===2?o=.44:o=.3,i.classList.remove("is-active-intro")}else o=0,i.classList.remove("is-active-intro");else i.classList.remove("is-active-intro");this.setProgress(i,o)})}measureNaturalHeight(){if(!this.introScreen)return 0;const e=this.introScreen.getBoundingClientRect(),t=this.introScreen.cloneNode(!0);t.style.position="absolute",t.style.top="-9999px",t.style.left="0",t.style.visibility="hidden",t.style.pointerEvents="none",t.style.opacity="0",t.style.transform="none",t.style.height="auto",t.style.minHeight="0",e&&e.width&&(t.style.width=Math.round(e.width)+"px"),t.classList.remove("is-animating"),t.querySelectorAll("[hidden]").forEach(r=>{r.hidden=!1,r.removeAttribute("hidden")}),t.querySelectorAll(".bould-widget__intro-step").forEach(r=>{r.classList.add("is-visible","is-active-intro"),r.classList.remove("is-highlight"),r.removeAttribute("style"),r.style.setProperty("--intro-progress","1")});const i=t.querySelector(".bould-widget__actions--intro");i&&(i.hidden=!1,i.removeAttribute("hidden"),i.classList.add("is-visible"),i.removeAttribute("style"),i.setAttribute("aria-hidden","false"));const s=this.introScreen.parentNode;if(!s)return 0;s.insertBefore(t,this.introScreen);const o=t.getBoundingClientRect();return s.removeChild(t),o&&o.height?Math.ceil(o.height):0}lockHeight(e){if(!this.introScreen)return;const t=this.introScreen.getBoundingClientRect(),i=t&&t.width?Math.round(t.width):0;if(i<=0){this.heightLock.height&&(this.introScreen.style.minHeight=this.heightLock.height+"px",this.introScreen.style.height=this.heightLock.height+"px");return}if(!e&&this.heightLock.height&&this.heightLock.width===i){this.introScreen.style.minHeight=this.heightLock.height+"px",this.introScreen.style.height=this.heightLock.height+"px";return}const s=this.measureNaturalHeight();s>0&&(this.heightLock={width:i,height:s},this.introScreen.style.minHeight=s+"px",this.introScreen.style.height=s+"px",this.introScreen.setAttribute("data-height-lock","true"))}unlockHeight(){this.introScreen&&(this.introScreen.style.height="",this.introScreen.style.minHeight="",this.introScreen.removeAttribute("data-height-lock"))}runAnimation(){if(!this.introScreen)return;if(this.clearAnimation(),this.lockHeight(!1),this.updateProgress(-1),!this.introSteps.length){this.introActions&&(this.introActions.hidden=!1,this.introActions.removeAttribute("hidden"),this.introActions.classList.add("is-visible"),this.introActions.setAttribute("aria-hidden","false")),this.unlockHeight();return}if(typeof window.matchMedia=="function"&&window.matchMedia("(prefers-reduced-motion: reduce)").matches){this.lockHeight(!0),this.introSteps.forEach(l=>{l.setAttribute("aria-hidden","false"),l.style.visibility="",l.style.opacity="",l.classList.add("is-visible"),this.setProgress(l,1),l.classList.add("is-active-intro")}),this.introActions&&(this.introActions.hidden=!1,this.introActions.removeAttribute("hidden"),this.introActions.classList.add("is-visible"),this.introActions.setAttribute("aria-hidden","false")),this.introScreen?(this.introScreen.classList.remove("is-animating"),requestAnimationFrame(()=>{this.unlockHeight()})):this.unlockHeight();return}this.introScreen.classList.add("is-animating");const t=220,i=1e3,s=620,o=360;this.lockHeight(!1);let r=t;this.introSteps.forEach((l,d)=>{this.queueTimeout(()=>{requestAnimationFrame(()=>{l.style.transitionDelay="0ms",l.setAttribute("aria-hidden","false"),l.style.visibility="",l.style.opacity="",l.classList.add("is-visible"),this.updateProgress(d)})},r),d===this.introSteps.length-1&&this.queueTimeout(()=>{this.introActions&&(this.introActions.hidden=!1,this.introActions.removeAttribute("hidden"),this.introActions.classList.add("is-visible"),this.introActions.setAttribute("aria-hidden","false")),this.introScreen?(this.introScreen.classList.remove("is-animating"),requestAnimationFrame(()=>{this.unlockHeight()})):this.unlockHeight()},r+s+o),r+=i})}}class Ne{constructor(e){this.widgetId=e,this.viewer=null,this.image=null,this.frame=null,this.closeBtn=null,this.hideTimer=null,this.returnFocusEl=null,this.handleKeydown=this.handleKeydown.bind(this),this.init()}init(){this.viewer=this.createViewer(),this.viewer&&(this.image=this.viewer.querySelector(".bould-widget__image-viewer__img"),this.frame=this.viewer.querySelector(".bould-widget__image-viewer__frame"),this.closeBtn=this.viewer.querySelector(".bould-widget__image-viewer__close"),this.bindEvents())}createViewer(){if(typeof document>"u"||!document.body)return null;if(this.widgetId){const o=document.querySelectorAll(".bould-widget__image-viewer");for(let r=0;r<o.length;r+=1){const l=o[r];if(l&&l.getAttribute("data-widget-id")===this.widgetId)return l}}const e=document.createElement("div");e.className="bould-widget__image-viewer",this.widgetId&&e.setAttribute("data-widget-id",this.widgetId),e.hidden=!0,e.setAttribute("aria-hidden","true");const t=document.createElement("div");t.className="bould-widget__image-viewer__frame",t.setAttribute("role","dialog"),t.setAttribute("aria-modal","true"),t.setAttribute("aria-label","Result preview"),t.tabIndex=-1;const i=document.createElement("button");i.type="button",i.className="bould-widget__image-viewer__close",i.setAttribute("aria-label","Close result preview"),i.textContent="Ã—";const s=document.createElement("img");return s.className="bould-widget__image-viewer__img",s.alt="Try on result preview",t.appendChild(i),t.appendChild(s),e.appendChild(t),document.body.appendChild(e),e}bindEvents(){this.viewer&&this.viewer.addEventListener("click",e=>{(!this.frame||e.target===this.viewer||!this.frame.contains(e.target))&&this.close()}),this.closeBtn&&this.closeBtn.addEventListener("click",e=>{e&&(e.preventDefault(),e.stopPropagation()),this.close()}),this.frame&&this.frame.addEventListener("click",e=>{e.stopPropagation()})}open(e,t,i){!this.viewer||!this.image||!e||(this.hideTimer&&(clearTimeout(this.hideTimer),this.hideTimer=null),this.returnFocusEl=i instanceof HTMLElement?i:null,this.image.src=e,this.image.alt=t||"Try on result",this.frame&&this.frame.setAttribute("aria-label",t?"Result preview: "+t:"Result preview"),this.viewer.hidden=!1,this.viewer.setAttribute("aria-hidden","false"),requestAnimationFrame(()=>{this.viewer.classList.add("is-visible")}),document.addEventListener("keydown",this.handleKeydown),this.closeBtn&&typeof this.closeBtn.focus=="function"&&setTimeout(()=>{try{this.closeBtn.focus({preventScroll:!0})}catch{this.closeBtn.focus()}},50))}close(e){if(!this.viewer||this.viewer.hidden)return;this.hideTimer&&(clearTimeout(this.hideTimer),this.hideTimer=null),this.viewer.classList.remove("is-visible"),document.removeEventListener("keydown",this.handleKeydown);const t=()=>{if(this.hideTimer=null,this.image&&this.image.removeAttribute("src"),this.viewer.setAttribute("aria-hidden","true"),this.viewer.hidden=!0,this.returnFocusEl&&typeof this.returnFocusEl.focus=="function")try{this.returnFocusEl.focus({preventScroll:!0})}catch{this.returnFocusEl.focus()}this.returnFocusEl=null};e?t():this.hideTimer=setTimeout(t,200)}handleKeydown(e){e&&(e.key==="Escape"||e.key==="Esc")&&(e.preventDefault(),this.close())}}class He{constructor(e){this.loadingScreen=e.loadingScreen,this.loadingStatusEl=e.loadingStatusEl,this.loadingFeedbackEl=e.loadingFeedbackEl,this.loadingGeneratingEl=e.loadingGeneratingEl,this.activeFeedbackCycle=null,this.defaultText=this.loadingStatusEl?this.loadingStatusEl.dataset.defaultText||this.loadingStatusEl.textContent:"",this.loadingStatusEl&&!this.loadingStatusEl.dataset.defaultText&&(this.loadingStatusEl.dataset.defaultText=this.defaultText)}setGeneratingActive(e){this.loadingGeneratingEl&&(e?(this.loadingGeneratingEl.hidden=!1,this.loadingGeneratingEl.removeAttribute("hidden"),this.loadingGeneratingEl.classList.add("is-active"),this.loadingGeneratingEl.setAttribute("aria-hidden","false")):(this.loadingGeneratingEl.classList.remove("is-active"),this.loadingGeneratingEl.setAttribute("aria-hidden","true"),this.loadingGeneratingEl.hidden=!0))}stopFeedbackCycle(e){this.activeFeedbackCycle&&typeof this.activeFeedbackCycle.cancel=="function"&&this.activeFeedbackCycle.cancel(!!e),this.activeFeedbackCycle=null}reset(){if(this.stopFeedbackCycle(!0),this.loadingStatusEl){this.loadingStatusEl.hidden=!1;const e=this.loadingStatusEl.dataset.defaultText||this.defaultText;e&&(this.loadingStatusEl.textContent=e)}this.loadingFeedbackEl&&(this.loadingFeedbackEl.hidden=!0,this.loadingFeedbackEl.classList.remove("is-visible"),this.loadingFeedbackEl.textContent=""),this.setGeneratingActive(!0)}startFeedback(e,t){const i=Array.isArray(e)?e.map(_=>typeof _=="string"?_.replace(/\s+/g," ").trim():"").filter(Boolean):[];if(!this.loadingFeedbackEl||!i.length){const _=i.length?i[i.length-1]:"";return{promise:Promise.resolve({finalMessage:_||"",cancelled:!1}),cancel:function(){}}}const s=Object.assign({loop:!1,holdMs:ze,fadeMs:Re,finalHoldMs:Oe,initialDelay:30,hideStatus:!0,loopCount:null},t||{}),o=this.loadingFeedbackEl;s.hideStatus&&this.loadingStatusEl&&(this.loadingStatusEl.hidden=!0),o.hidden=!1,o.classList.remove("is-visible"),o.textContent="";let r=!1,l=null;const d=[],w=typeof s.loopCount=="number"&&s.loopCount>0?s.loopCount:null;let S=0;const x=()=>{for(;d.length;)clearTimeout(d.pop())},F=(_,I)=>{if(r)return;r=!0,x();const G=I!=null&&I!==""?I:o.textContent||i[i.length-1]||"";l&&l({finalMessage:G,cancelled:_})},C=_=>{if(r)return;if(!i.length){F(!0,"");return}const I=_%i.length,G=i[I];o.classList.remove("is-visible"),o.textContent=G,d.push(setTimeout(()=>{r||(o.classList.add("is-visible"),d.push(setTimeout(()=>{if(r)return;const $=I===i.length-1,le=(I+1)%i.length;if(s.loop){if(le===0&&(S+=1,w&&S>=w)){F(!1,G);return}o.classList.remove("is-visible"),d.push(setTimeout(()=>{r||C(le)},s.fadeMs))}else $?F(!1,G):(o.classList.remove("is-visible"),d.push(setTimeout(()=>{r||C(I+1)},s.fadeMs)))},s.holdMs)))},50))},Q={promise:new Promise(_=>{l=_,d.push(setTimeout(()=>{C(0)},Math.max(0,s.initialDelay)))}).then(_=>(this.activeFeedbackCycle===Q&&(this.activeFeedbackCycle=null),_)),cancel:_=>{if(r){_&&o.classList.remove("is-visible");return}_&&o.classList.remove("is-visible"),F(!0)}};return this.activeFeedbackCycle=Q,Q}}class Ge{constructor(e){this.resultScreen=e.resultScreen,this.resultImageEl=e.resultImageEl,this.resultSizeEl=e.resultSizeEl,this.resultConfidenceEl=e.resultConfidenceEl,this.resultFeedbackEl=e.resultFeedbackEl,this.resultStageEls=e.resultStageEls||[],this.matchDetails={},this.currentUnit="cm",this.handleToggle=this.handleToggle.bind(this)}reset(){this.resultStageEls.forEach(e=>{e&&e.classList.remove("is-visible")}),this.resultImageEl&&(this.resultImageEl.removeAttribute("src"),this.resultImageEl.hidden=!1),this.resultSizeEl&&(this.resultSizeEl.textContent="",this.resultSizeEl.hidden=!1),this.resultConfidenceEl&&(this.resultConfidenceEl.textContent="",this.resultConfidenceEl.hidden=!1),this.resultFeedbackEl&&(this.resultFeedbackEl.textContent="",this.resultFeedbackEl.hidden=!1,this.resultFeedbackEl.classList.remove("is-visible")),this.matchDetails={},this.currentUnit="cm"}handleToggle(){this.currentUnit=this.currentUnit==="cm"?"inch":"cm",this.renderMeasurements()}renderMeasurements(){if(!this.resultConfidenceEl)return;const e=this.currentUnit==="inch"?"in":"cm";let t="";const i=this.matchDetails&&this.matchDetails.slacks?this.matchDetails.slacks:{},s=this.matchDetails&&this.matchDetails.unit?this.matchDetails.unit:"cm",o={};for(const[l,d]of Object.entries(i))s==="cm"&&this.currentUnit==="inch"?o[l]=d/2.54:s==="inch"&&this.currentUnit==="cm"?o[l]=d*2.54:o[l]=d;const r=Object.entries(o).filter(([l,d])=>l&&!Number.isNaN(d)).sort((l,d)=>Math.abs(d[1])-Math.abs(l[1])).slice(0,3);if(r.length>0){const l=r.map(([d,w])=>{const S=d.split("_").map(F=>F.charAt(0).toUpperCase()+F.slice(1)).join(" "),x=w>0?"+":"";return`${S} ${x}${w.toFixed(1)}`});t=`Slack (${e}): ${l.join(", ")}`}this.resultConfidenceEl.textContent=t,this.resultConfidenceEl.hidden=!t}reveal(e,t){this.resultScreen&&(this.resultImageEl&&(e.imageUrl?(this.resultImageEl.hidden=!1,this.resultImageEl.src!==e.imageUrl&&(this.resultImageEl.src=e.imageUrl)):(this.resultImageEl.removeAttribute("src"),this.resultImageEl.hidden=!0)),this.resultSizeEl&&(e.sizeText?(this.resultSizeEl.textContent=e.sizeText,this.resultSizeEl.hidden=!1):(this.resultSizeEl.textContent="",this.resultSizeEl.hidden=!0)),this.resultConfidenceEl&&(this.matchDetails=e.matchDetails||{},this.currentUnit=e.displayUnit||"cm",this.renderMeasurements()),this.resultFeedbackEl&&(e.feedbackText?(this.resultFeedbackEl.textContent=e.feedbackText,this.resultFeedbackEl.hidden=!1):(this.resultFeedbackEl.textContent="",this.resultFeedbackEl.hidden=!0),this.resultFeedbackEl.classList.remove("is-visible")),typeof t=="function"&&t("result"),requestAnimationFrame(()=>{requestAnimationFrame(()=>{this.resultStageEls.forEach(i=>{if(i){if(i===this.resultImageEl&&!e.imageUrl){i.classList.remove("is-visible");return}i.classList.add("is-visible")}}),this.resultFeedbackEl&&this.resultFeedbackEl.classList.contains("bould-widget__fade-text")&&e.feedbackText&&this.resultFeedbackEl.classList.add("is-visible")})}))}}function T(n){return String(n??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function $e(n){return T(n).replace(/\r?\n/g,"<br />")}function Ee(){try{return!!(window.Shopify&&window.Shopify.designMode)}catch{return!1}}function je(){try{if(navigator!=null&&navigator.userAgentData&&typeof navigator.userAgentData.mobile=="boolean")return navigator.userAgentData.mobile}catch{}const n=(navigator.userAgent||navigator.vendor||window.opera&&window.opera.toString&&window.opera.toString()||"").toLowerCase(),e=/(android|iphone|ipad|ipod|windows phone|blackberry|bb10|mobile)/i.test(n),t=typeof window.matchMedia=="function"&&window.matchMedia("(pointer: coarse)").matches,i=typeof window.matchMedia=="function"&&window.matchMedia("(max-width: 820px)").matches;return e||t&&i}function Ke(n){if(!n)return[];const e=String(n).replace(/\s+/g," ").match(/[^.!?]+[.!?]*/g);return e?e.map(function(t){return t.trim()}).filter(Boolean):[String(n).trim()]}function Ve(n,e=""){if(!n||typeof n!="object")return["We're reviewing your fit details...","Hang tight - we're rendering your try-on preview now."];const t=n.tailor_feedback_sequence||n.tailor_feedbacks||n.tailorFeedbackSequence||n.tailorFeedbacks||n.tailor_feedback||n.tailorFeedback;let i=[];if(Array.isArray(t)?i=t:t&&typeof t=="object"&&Array.isArray(t.messages)?i=t.messages:t!=null&&(i=[t]),i=i.map(function(r){return String(r||"").replace(/\s+/g," ").trim()}).filter(Boolean),!i.length&&e&&(i=[e]),i.length===1){const r=i[0],l=r.split(/\n+/).map(function(d){return d.replace(/\s+/g," ").trim()}).filter(Boolean);if(l.length>=2)i=[l[0],l.slice(1).join(" ").trim()];else{const d=Ke(r);if(d.length>=2){const w=d.slice(1).join(" ").trim();w&&(i=[d[0],w])}}}const s=new Set,o=[];return i.forEach(function(r){s.has(r)||(s.add(r),o.push(r))}),o.length||o.push("We're reviewing your fit details..."),o.length===1&&o.push("Hang tight - we're rendering your try-on preview now."),o.slice(0,3)}function Je(n){return n?new Promise(function(e){const t=new Image;t.decoding="async",t.onload=function(){e({url:n,loaded:!0})},t.onerror=function(){e({url:n,loaded:!1})},t.src=n}):Promise.resolve({url:"",loaded:!1})}function Xe(n){const e=Array.isArray(n)?n.filter(Boolean):[];if(!e.length)return Promise.resolve({url:"",loaded:!1});let t=0;return new Promise(function(i){function s(){const o=e[t];Je(o).then(function(r){if(r.loaded){i(r);return}if(t<e.length-1){console.warn("[Bould Widget] Try-on image failed to load, trying next candidate",o),t+=1,s();return}i({url:o,loaded:!1})})}s()})}function X(n){const e=n.getAttribute("data-product-id")||"";if(e)return e;try{const t=window.ShopifyAnalytics&&window.ShopifyAnalytics.meta&&window.ShopifyAnalytics.meta.product&&window.ShopifyAnalytics.meta.product.id||null;if(t)return`gid://shopify/Product/${t}`}catch{}return""}function Qe(n){const e=n.getAttribute("data-product-image")||"";if(e)return e;try{const t=window.ShopifyAnalytics&&window.ShopifyAnalytics.meta&&window.ShopifyAnalytics.meta.product;if(t){if(typeof t.image_url=="string"&&t.image_url)return t.image_url;if(Array.isArray(t.images)&&t.images.length>0)return t.images[0]}}catch{}return""}function Ae(){try{const n=window.Shopify&&window.Shopify.customer;if(n&&(n.id||n.email))return!0}catch{}try{const n=window.ShopifyAnalytics&&window.ShopifyAnalytics.meta;if(n&&(n.page&&n.page.customerId||n.customerId))return!0}catch{}try{const n=document.cookie?document.cookie.split(";"):[];for(let e=0;e<n.length;e+=1){const t=n[e].trim();if(!t)continue;const i=t.indexOf("=");if(i===-1)continue;const s=t.slice(0,i),o=t.slice(i+1);if(s==="customer_signed_in"){const r=o.toLowerCase();if(r==="true"||r==="1"||r==="yes")return!0}}}catch{}return!1}class Ye{constructor(e,t){this.container=e,this.openBtn=t}ensureStateNotice(){let e=this.container.querySelector(".bould-widget__state");return e||(e=document.createElement("div"),e.className="bould-widget__state",e.hidden=!0,this.openBtn&&typeof this.openBtn.insertAdjacentElement=="function"?this.openBtn.insertAdjacentElement("afterend",e):this.container.appendChild(e)),e}showInline(e,t){const i=this.ensureStateNotice();i.className="bould-widget__state",t==="warning"?i.classList.add("bould-widget__state--warning"):t==="error"&&i.classList.add("bould-widget__state--error"),i.innerHTML=`<p>${T(e)}</p>`,i.hidden=!1}clearInline(){const e=this.container.querySelector(".bould-widget__state");e&&(e.className="bould-widget__state",e.innerHTML="",e.hidden=!0)}ensureUpgradeNotice(){let e=this.container.querySelector(".bould-widget__upgrade");return e||(e=document.createElement("div"),e.className="bould-widget__upgrade",this.container.appendChild(e)),e}applyPlanState(e){const t=e&&e.plan?e.plan:null,i=!!(t&&t.blocked),s=this.container.querySelector(".bould-widget__upgrade"),o=!!(window.Shopify&&window.Shopify.designMode);if(i){const r=t&&t.message?t.message:Se;if(o){const l=s||this.ensureUpgradeNotice();l.textContent=r,l.hidden=!1}else s&&(s.textContent="",s.hidden=!0);this.container.setAttribute("data-plan-blocked","true"),this.openBtn&&(this.openBtn.disabled=!0,this.openBtn.classList.add("bould-widget__open--disabled"),this.openBtn.style.display=o?"":"none",this.openBtn.setAttribute("data-disabled-reason","plan-blocked"),this.openBtn.setAttribute("title",r),this.openBtn.setAttribute("aria-disabled","true"))}else this.container.removeAttribute("data-plan-blocked"),s&&(s.textContent="",s.hidden=!0),this.openBtn&&(this.openBtn.style.display="",this.openBtn.disabled=!1,this.openBtn.classList.remove("bould-widget__open--disabled"),this.openBtn.removeAttribute("data-disabled-reason"),this.openBtn.removeAttribute("title"),this.openBtn.removeAttribute("aria-disabled"))}setOpenButtonDisabled(e,t,i){this.openBtn&&(!e&&this.container.getAttribute("data-plan-blocked")==="true"||(e?(this.openBtn.disabled=!0,this.openBtn.classList.add("bould-widget__open--disabled"),this.openBtn.setAttribute("aria-disabled","true"),t&&this.openBtn.setAttribute("data-disabled-reason",t),i&&this.openBtn.setAttribute("title",i)):(this.openBtn.disabled=!1,this.openBtn.classList.remove("bould-widget__open--disabled"),this.openBtn.removeAttribute("aria-disabled"),(!t||this.openBtn.getAttribute("data-disabled-reason")===t)&&this.openBtn.removeAttribute("data-disabled-reason"),(!i||this.openBtn.getAttribute("title")===i)&&this.openBtn.removeAttribute("title"))))}renderDebugInfo(e){if(!e)return"";const t=[];return e.requestId&&t.push(`Request ID: ${T(e.requestId)}`),e.productId&&t.push(`Product ID: ${T(e.productId)}`),e.conversionStatus&&t.push(`Conversion Status: ${T(e.conversionStatus)}`),e.statusCode&&t.push(`Status Code: ${T(e.statusCode)}`),e.timestamp&&t.push(`Timestamp: ${T(e.timestamp)}`),e.suggestion&&t.push(`Suggestion: ${T(e.suggestion)}`),e.reason&&t.push(`Reason: ${T(e.reason)}`),e.correlationId&&t.push(`Correlation ID: ${T(e.correlationId)}`),e.responseCorrelationId&&t.push(`Response ID: ${T(e.responseCorrelationId)}`),t.length?`<div class="bould-widget__debug-info"><strong>Debug Information:</strong><br>${t.join("<br>")}</div>`:""}}class Ze{constructor(e){this.container=e}getStorageKey(){const e=X(this.container);return"bould_result_"+(e?e.replace(/\W/g,"_"):"default")}save(e){if(Ae())try{const t=this.getStorageKey();localStorage.setItem(t,JSON.stringify({details:e,timestamp:Date.now()}))}catch(t){console.warn("[Bould Widget] Failed to save result to storage",t)}}load(){if(!Ae())return null;try{const e=this.getStorageKey(),t=localStorage.getItem(e);return t?JSON.parse(t).details:null}catch(e){return console.warn("[Bould Widget] Failed to load result from storage",e),null}}}class et{constructor(e){this.container=e}getEndpointBase(){const e=this.container.getAttribute("data-api-base");return e&&e!=="use_app_route"&&e!=="use_app_proxy"?e:"/apps/bould"}async fetchStatus(){const e=X(this.container),t=Ee();if(!e&&!t)return null;const i=Math.random().toString(36).slice(2,10),s=new URLSearchParams;s.set("intent","status"),e&&s.set("product_id",e),t&&s.set("design_mode","1");const o=`${this.getEndpointBase()}?${s.toString()}`,r=await fetch(o,{headers:{Accept:"application/json","X-Correlation-ID":i}});if(!r.ok){const l=await r.text().catch(()=>"");return console.warn("[Bould Widget] Status check failed",r.status,l),null}return r.json()}getImmediateGate(e){return null}getPreflightGate(e,t){var i,s;if(!e)return null;if(e.plan&&e.plan.blocked)return{heading:"Upgrade required",message:e.plan.message||Se,tone:"warning",action:"close",blockButton:!0,code:"plan-blocked",debug:{requestId:(i=e==null?void 0:e.debug)==null?void 0:i.requestId,planId:e.plan.id,productId:e.productId||X(this.container),reason:"plan_blocked"}};if(!t&&e.isProcessed===!1){const o=e.conversionStatus||"not_ready";let r="Garment isn't ready yet",l="This garment has not been processed yet.",d="warning";return o==="processing"?(r="Garment still processing",l="We are still processing this garment. Please wait a few minutes and try again."):o==="failed"&&(r="Garment conversion failed",l="This garment is not available for try-on.",d="error"),{heading:r,message:l,tone:d,action:"close",blockButton:!1,code:"garment-unprocessed",debug:{requestId:(s=e==null?void 0:e.debug)==null?void 0:s.requestId,productId:e.productId||X(this.container),conversionStatus:o,reason:"garment_unprocessed"}}}return null}}(function(){document.querySelectorAll("[data-bould-widget]").forEach(function(n){const e=n.querySelector(".bould-widget__open"),t=n.querySelector(".bould-widget"),i=n.querySelector(".bould-widget__close"),s=t?t.querySelector(".bould-widget__header"):null,o=s?s.querySelector(".bould-widget__eyebrow"):null,r=s?s.querySelector(".bould-widget__title"):null,l=s?s.querySelector(".bould-widget__subtitle"):null,d={eyebrow:o?o.textContent.trim():"",title:r?r.textContent.trim():"",subtitle:l?l.textContent.trim():""},w=t?t.querySelector(".bould-widget__screen--loading"):null,S=w?w.querySelector(".bould-widget__loading-text"):null,x=w?w.querySelector("[data-loading-feedback]"):null,F=w?w.querySelector("[data-loading-generating]"):null,C=t?t.querySelector(".bould-widget__screen--result"):null,H=C?C.querySelector(".bould-widget__result-image"):null,Q=C?C.querySelector(".bould-widget__size"):null,_=C?C.querySelector(".bould-widget__confidence"):null,I=C?C.querySelector(".bould-widget__feedback"):null,G=C?Array.from(C.querySelectorAll(".bould-widget__result-stage")):[],$=t?t.querySelector(".bould-widget__screen--intro"):null,le=$?Array.from($.querySelectorAll(".bould-widget__intro-step")):[],ke=$?$.querySelector(".bould-widget__actions--intro"):null,U=t?t.querySelector(".bould-widget__screen--error [data-action]"):null,Ce=U?{label:U.textContent||"Try again",action:U.getAttribute("data-action")||"back-to-form"}:{label:"Try again",action:"back-to-form"};n&&n.classList&&!n.classList.contains("bould-widget--enhanced")&&n.classList.add("bould-widget--enhanced");const tt=n.getAttribute("data-block-id")||""||Math.random().toString(36).slice(2,8),me=new We({introScreen:$,introSteps:le,introActions:ke}),Le=new Ne(tt),E=new He({loadingScreen:w,loadingStatusEl:S,loadingFeedbackEl:x,loadingGeneratingEl:F}),Y=new Ge({resultScreen:C,resultImageEl:H,resultSizeEl:Q,resultConfidenceEl:_,resultFeedbackEl:I,resultStageEls:G}),q=new Ye(n,e),ce=new Ze(n),Z=new et(n);let ee=null,te=null,ie=null,B=null,de=null;const xe={header:s,headerEyebrow:o,headerTitle:r,headerSubtitle:l,modal:t,headerDefaults:d};_e("intro",xe);function D(c){t&&t.querySelectorAll(".bould-widget__screen").forEach(function(u){u.hidden=u.dataset.screen!==c}),_e(c,xe),c==="intro"?me.runAnimation():me.clearAnimation(),E.setGeneratingActive(c==="loading")}async function pe(){return ee||(ee=(async()=>{try{const c=await Z.fetchStatus();return q.applyPlanState(c),c}catch(c){return console.warn("[Bould Widget] Failed to determine plan status",c),q.applyPlanState(null),null}finally{ee=null}})(),ee)}function it(){E.stopFeedbackCycle(!0),Y.reset(),te=null,ie=null,B=null,de=null,x?(S&&(S.hidden=!0),x.hidden=!1,x.classList.remove("is-visible"),x.textContent="",te=E.startFeedback(fe,{loop:!0,holdMs:2600,fadeMs:600,initialDelay:0,hideStatus:!1}),ie=te?te.promise:null):E.reset(),D("loading")}async function st(){const c=Ee(),u=Z.getImmediateGate(c);if(u){q.showInline(u.message,u.tone||"warning"),u.blockButton&&q.setOpenButtonDisabled(!0,u.code||"immediate-gate",u.message),u.debug&&console.info("[Bould Widget] Immediate gate triggered",u.debug);return}q.setOpenButtonDisabled(!1);let y=null;try{y=await pe()}catch{y=null}const h=Z.getPreflightGate(y,c);if(h){q.showInline(h.message,h.tone||"warning"),h.blockButton?q.setOpenButtonDisabled(!0,h.code||"preflight-gate",h.message):q.setOpenButtonDisabled(!1),h.debug&&console.info("[Bould Widget] Preflight gate triggered",h.debug);return}if(q.clearInline(),q.setOpenButtonDisabled(!1),(!t.parentElement||t.parentElement!==document.body)&&document.body.appendChild(t),t.hidden=!1,t.setAttribute("data-state","opening"),y&&y.isOneSizeFitsAll===!0){console.log("[Bould Widget] One Size Fits All item detected from preflight"),E.reset();const g={imageUrl:"",sizeText:"",confidenceText:"",feedbackText:"This item is one size and fits everyone.",matchDetails:{},displayUnit:"cm",isOneSizeFitsAll:!0};ce.save(g),Y.reveal(g,D),setTimeout(function(){t.removeAttribute("data-state")},250);return}const b=ce.load();if(b){Y.reveal(b,D),E.reset(),setTimeout(function(){t.removeAttribute("data-state")},250);return}D("intro"),setTimeout(function(){t.removeAttribute("data-state")},250)}function be(){t.hidden=!0,Le.close(!0),E.stopFeedbackCycle(),E.reset(),me.clearAnimation()}function Be(c,u=null,y={}){const h=t.querySelector(".bould-widget__screen--error");if(!h)return;const b=h.querySelector("h3");b&&(b.textContent=y.heading||Pe),U&&(y.action==="close"?(U.textContent=y.actionLabel||"Close",U.setAttribute("data-action","close")):(U.textContent=Ce.label,U.setAttribute("data-action",Ce.action)));const g=h.querySelector(".bould-widget__error");if(g){g.className="bould-widget__error",g.classList.add("bould-widget__error--danger"),y.tone==="info"?(g.classList.remove("bould-widget__error--danger"),g.classList.add("bould-widget__error--info")):y.tone==="warning"?(g.classList.remove("bould-widget__error--danger"),g.classList.add("bould-widget__error--warn")):y.tone==="error"&&g.classList.add("bould-widget__error--danger");const se=[`<div class="bould-widget__error-content">${$e(c)}</div>`],j=q.renderDebugInfo(u);j&&se.push(j),g.innerHTML=se.join("")}D("error")}e&&e.addEventListener("click",st),i&&i.addEventListener("click",be),t&&t.addEventListener("click",function(c){c.target===t&&be()}),t&&t.addEventListener("click",function(c){const u=c.target;u instanceof HTMLElement&&(u.matches('[data-action="continue"]')?D("form"):u.matches('[data-action="close"]')?be():(u.matches('[data-action="back-to-form"]')||u.matches('[data-action="retake"]'))&&D("form"))}),H&&H.addEventListener("click",function(){const c=H.getAttribute("src");if(!c)return;const u=H.getAttribute("alt")||"Try on result";if(je()){Le.open(c,u,H);return}const y=window.open(c,"_blank","noopener");if(y&&typeof y=="object")try{y.opener=null}catch{}else window.location.href=c});const P=n.querySelector(".bould-widget__form");if(P){let se=function(){if(!c)return;const L=u?String(u.value||"").toLowerCase():"cm";L==="inch"||L==="inches"||L==="in"?g?(g.style.display="flex",c.style.display="none",c.required=!1,h&&(h.required=!0),b&&(b.required=!0)):(c.placeholder="Height (in)",c.min="25",c.max="107"):(g&&(g.style.display="none",h&&(h.required=!1),b&&(b.required=!1),c.style.display="block",c.required=!0),c.placeholder="Height (cm)",c.min="65",c.max="272")};const c=P.querySelector('input[name="height"]'),u=P.querySelector('select[name="body_unit"]'),y=c?c.parentElement:null;let h=null,b=null,g=null;if(u&&(u.style.appearance="none",u.style.backgroundImage=`url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 10 6' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L5 5L9 1' stroke='%236B7280' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E")`,u.style.backgroundRepeat="no-repeat",u.style.backgroundPosition="right 12px center",u.style.paddingRight="32px"),y){g=document.createElement("div"),g.className="bould-widget__imperial-inputs",g.style.display="none",g.style.gap="8px",g.style.width="100%",h=document.createElement("input"),h.type="number",h.placeholder="Ft",h.className=c.className,h.min="2",h.max="8",h.style.flex="1",h.required=!0,b=document.createElement("input"),b.type="number",b.placeholder="In",b.className=c.className,b.min="0",b.max="11",b.style.flex="1",b.required=!0,g.appendChild(h),g.appendChild(b),c.nextSibling?y.insertBefore(g,c.nextSibling):y.appendChild(g);const L=()=>{const K=parseInt(h.value)||0,z=parseInt(b.value)||0,ne=K*12+z;c.value=ne>0?ne:""};h.addEventListener("input",L),b.addEventListener("input",L)}se(),u&&u.addEventListener("change",se);const j=P.querySelector('input[name="user_image"]'),ue=P.querySelector(".bould-widget__upload-text"),J=P.querySelector(".bould-widget__upload-icon");j&&j.addEventListener("change",function(){if(j.files&&j.files[0]){ue&&(ue.textContent="Image loaded",ue.style.color="#4F46E5",ue.style.fontWeight="600"),J&&(J.innerHTML='<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>',J.style.background="#4F46E5",J.style.color="#ffffff",J.style.transform="none",J.style.boxShadow="0 4px 12px rgba(79, 70, 229, 0.35)");const L=P.querySelector(".bould-widget__file-upload");L&&(L.style.borderColor="#4F46E5",L.style.borderStyle="solid",L.style.background="#EEF2FF")}}),P.addEventListener("submit",async function(L){L.preventDefault();const K=new FormData(P),z=K.get("user_image"),ne=K.get("height"),Te=K.get("body_unit"),Fe=typeof Te=="string"?Te.toLowerCase():"cm",ye=Qe(n);if(!(z instanceof File)||!ne)return Be("Missing image or height.");ye&&K.set("product_image_url",ye);let re=[],nt="",he="";it();try{const f=X(n),R=Math.random().toString(36).slice(2,10),M=Z.getEndpointBase(),O=f?`${M}?product_id=${encodeURIComponent(f)}`:M;console.log("[Bould Widget] Making request to:",O),console.log("[Bould Widget] Form data:",{hasImage:z instanceof File,imageSize:z instanceof File?z.size:"N/A",height:ne,imageType:z instanceof File?z.type:"N/A",bodyUnit:Fe,productId:f,correlationId:R,productImageUrl:ye});const Ie=new AbortController,rt=setTimeout(()=>Ie.abort(),28e3),v=await fetch(O,{method:"POST",body:K,headers:{Accept:"application/json","X-Correlation-ID":R},signal:Ie.signal}).finally(()=>clearTimeout(rt));console.log("[Bould Widget] Response status:",v.status);const oe=Object.fromEntries(v.headers.entries());if(console.log("[Bould Widget] Response headers:",oe),!v.ok){let m="Unknown server error",W={};if(!(v.headers.get("content-type")||"").includes("application/json")){const p=await v.text().catch(()=>"");m=`Server error: ${v.status}. Received non-JSON response. This often indicates a proxy misconfiguration.`;const A=new Error(m);throw A.debugInfo={correlationId:R,productId:f,responseCorrelationId:oe["x-correlation-id"]||oe["x-request-id"],hint:"Verify Shopify App Proxy path maps to /apps/bould",responseSnippet:p.slice(0,200)},A.statusCode=v.status,A}try{const p=await v.json();console.log("[Bould Widget] Error response data:",p),p.debug&&(W=p.debug,console.log("[Bould Widget] Debug info:",W)),v.status===404?m="Widget endpoint not found. Please check your configuration.":v.status===409?p.error&&(p.error.includes("not processed")||p.error.includes("not been converted"))?m="This garment hasn't been edited.":p.error&&p.error.includes("processing")?m="This garment is currently being processed. Please wait a few minutes and try again.":p.error&&p.error.includes("failed")?m="Garment conversion failed. Please try converting again in the Bould app.":m=p.error||"This garment hasn't been edited.":v.status===502?m="Garment processing service is unavailable. Please ensure the garment has been properly converted.":v.status===504?m="The request timed out. Please try again in a moment.":v.status===500?m=p.error||"Internal server error. Please try again later.":m=p.error||`Server error: ${v.status}`}catch(p){console.error("[Bould Widget] Failed to parse error response:",p),m=v.status===504?"The request timed out at the edge (504). Please try again.":`Server error: ${v.status} - Unable to parse error response`}const V=new Error(m);throw V.debugInfo=Object.assign({correlationId:R,productId:f,responseCorrelationId:oe["x-correlation-id"]||oe["x-request-id"]},W||{}),V.statusCode=v.status,V}const a=await v.json();console.log("[Bould Widget] Success response:",a);const ot=typeof a.display_unit=="string"?a.display_unit:Fe,qe=String(ot||"cm").toLowerCase()==="inch"?"inch":"cm",at=a&&typeof a=="object"?a.match_details||a.matchDetails||{}:{};if(re=Array.isArray(a.preview_feedback)&&a.preview_feedback.length?a.preview_feedback:Ve(a,(S==null?void 0:S.dataset.defaultText)||"").slice(0,3),re.length,he=a.final_feedback||a.tailor_feedback||"",he||(he=re.join(" ").trim()),E.stopFeedbackCycle(!1),ie)try{await ie}catch(m){console.info("[Bould Widget] Default feedback sequence ended early",m)}te=null,ie=null;const lt=(re.length?re:[fe[fe.length-1]]).slice(0,3);if(B=E.startFeedback(lt,{loop:!0,holdMs:2800,fadeMs:600,initialDelay:0,hideStatus:!0}),de=B?B.promise:null,a&&a.queued){if(!a.task_id)throw console.error("[Bould Widget] Queued response missing task_id:",a),new Error("The try-on service queued your request but did not provide a task ID. Please try again or contact support.");console.log("[Bould Widget] Try-on queued. Polling for completion. task_id=",a.task_id);const m=Date.now(),W=55e3,ge=1500,V=a.task_id;let p=0;for(;Date.now()-m<W;){await new Promise(A=>setTimeout(A,ge)),p+=1,console.log(`[Bould Widget] Polling attempt #${p}, elapsed: ${Date.now()-m}ms`);try{const A=`${M}?intent=tryon_status&task_id=${encodeURIComponent(V)}`;console.log("[Bould Widget] Polling URL:",A);const N=await fetch(A,{headers:{Accept:"application/json","X-Correlation-ID":R}});if(console.log("[Bould Widget] Poll response status:",N.status),N.ok){const k=await N.json();if(console.log("[Bould Widget] Poll response data:",k),k&&k.result_image_url){console.log("[Bould Widget] Try-on complete! Image URL:",k.result_image_url),a.tryOnImageUrl=k.result_image_url;break}if(k&&k.status){console.log("[Bould Widget] Try-on status:",k.status);const ft=String(k.status).toLowerCase();if(["fail","failed","error"].includes(ft)){const mt=k.error||"The try-on provider reported a failure.";throw new Error(`Try-on failed: ${mt}`)}}}else{const k=await N.text().catch(()=>"");console.warn("[Bould Widget] Status poll failed",N.status,k)}}catch(A){console.warn("[Bould Widget] Status poll error",A)}}if(!a.tryOnImageUrl)throw console.error("[Bould Widget] Polling timed out after",Date.now()-m,"ms"),new Error("The request timed out before the try-on image was ready. Please try again.")}if(!a||a.error)throw a.error&&a.error.includes("not processed")?new Error("This garment has not been converted yet. Please run conversion in the Bould app first."):new Error(a.error||"Invalid response from server.");if(a.isOneSizeFitsAll===!0){console.log("[Bould Widget] One Size Fits All response received"),B&&typeof B.cancel=="function"&&B.cancel(!0),B=null,de=null,E.stopFeedbackCycle(!0);let m=a.tryOnImageUrl||"";if(a.queued&&a.task_id){console.log("[Bould Widget] One Size Fits All try-on queued, polling...");const ge=Date.now(),V=55e3,p=1500;for(;Date.now()-ge<V;){await new Promise(A=>setTimeout(A,p));try{const A=`${Z.getEndpointBase()}?intent=tryon_status&task_id=${encodeURIComponent(a.task_id)}`,N=await fetch(A,{headers:{Accept:"application/json"}});if(N.ok){const k=await N.json();if(k&&k.result_image_url){m=k.result_image_url;break}}}catch(A){console.warn("[Bould Widget] One Size poll error",A)}}}const W={imageUrl:m,sizeText:"",confidenceText:"",feedbackText:a.message||"This item is one size and fits everyone.",matchDetails:{},displayUnit:"cm",isOneSizeFitsAll:!0};ce.save(W),Y.reveal(W,D),E.reset();return}const ct=a.recommended_size||a.recommendedSize||"",dt=String(ct||"").trim(),yt=qe==="inch"?"inches":"centimeters",ut="Recommended size: "+(dt||"-");let De="";if(a.confidence!==void 0&&a.confidence!==null&&a.confidence!==""){const m=Number(a.confidence);Number.isNaN(m)||(De="Confidence: "+m.toFixed(2)+"%")}const ae=[];a.tryOnImageUrl&&ae.push(a.tryOnImageUrl),a.try_on_image_url&&a.try_on_image_url!==a.tryOnImageUrl&&ae.push(a.try_on_image_url),a.tryonImageUrl&&a.tryonImageUrl!==a.tryOnImageUrl&&ae.push(a.tryonImageUrl),a.debug&&a.debug.measurement_vis_url&&ae.push(a.debug.measurement_vis_url);const we=await Xe(ae);if(B&&typeof B.cancel=="function"&&B.cancel(!0),B=null,de=null,E.stopFeedbackCycle(!0),t.hidden){console.info("[Bould Widget] Modal closed before result reveal."),E.reset();return}const ht=we&&we.loaded?we.url:"",gt=(he||"").trim()||S&&S.dataset.defaultText||"",Me={imageUrl:ht,sizeText:ut,confidenceText:De,feedbackText:gt,matchDetails:at,displayUnit:qe};ce.save(Me),Y.reveal(Me,D),E.reset()}catch(f){console.error("[Bould Widget] Error occurred:",f),E.reset();let R=f&&f.message?f.message:"Unknown error occurred. Please try again.";f&&f.name==="AbortError"&&(R="The request timed out before completing. Please try again in a moment.");let M=f&&f.debugInfo?{...f.debugInfo}:null;f&&f.statusCode&&(M||(M={}),M.statusCode=f.statusCode),M&&console.log("[Bould Widget] Debug information:",M);const O={};f&&f.statusCode===409?(O.tone="warning",O.heading="Action needed",O.action="close"):f&&f.statusCode&&f.statusCode>=500&&(O.tone="error"),Be(R,M,O),f&&f.statusCode===409&&pe()}})}pe()})})()})();
