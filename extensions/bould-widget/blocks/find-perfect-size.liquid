{% schema %}
{
  "name": "Bould size finder",
  "target": "section",
  "settings": [
    { "type": "text", "id": "button_label", "label": "Button label", "default": "Find my perfect size" },
    { "type": "text", "id": "button_classes", "label": "Additional button classes", "info": "Optional theme classes to apply to the launch button (e.g. 'button button--primary')." },
    { "type": "color", "id": "button_background_color", "label": "Button background color" },
    { "type": "color", "id": "button_text_color", "label": "Button text color" },
    { "type": "text", "id": "api_base", "label": "API base URL (optional)", "default": "use_app_proxy" }
  ]
}
{% endschema %}

{{ 'widget.css' | asset_url | stylesheet_tag }}
<script src="{{ 'widget.js' | asset_url }}" defer></script>

{% assign featured_image = product.featured_image %}
{% if featured_image == blank and product.images.size > 0 %}
  {% assign featured_image = product.images.first %}
{% endif %}

{% capture widget_style %}
  {% if block.settings.button_background_color != blank %}--bould-btn-bg: {{ block.settings.button_background_color }};{% endif %}
  {% if block.settings.button_text_color != blank %}--bould-btn-color: {{ block.settings.button_text_color }};{% endif %}
{% endcapture %}
{% assign widget_style = widget_style | strip | strip_newlines %}

{% assign extra_button_classes = block.settings.button_classes | strip %}

<div class="bould-widget-root bould-widget--enhanced" data-bould-widget data-block-id="{{ block.id }}" data-api-base="{{ block.settings.api_base }}" data-product-id="{{ product.admin_graphql_api_id }}" {% if featured_image != blank %}data-product-image="{{ featured_image | image_url: width: 2048 }}"{% endif %}{% if widget_style != blank %} style="{{ widget_style }}"{% endif %}>
  <button type="button" class="bould-widget__open bould-btn{% if extra_button_classes != blank %} {{ extra_button_classes }}{% endif %}">{{ block.settings.button_label }}</button>
  <div class="bould-widget__upgrade" hidden></div>

  <div class="bould-widget" role="dialog" aria-modal="true" aria-labelledby="bould-widget-title-{{ block.id }}" aria-describedby="bould-widget-subtitle-{{ block.id }}" hidden>
    <div class="bould-widget__modal" role="document">
      <header class="bould-widget__header">
        <div class="bould-widget__title-group">
          <h2 class="bould-widget__title" id="bould-widget-title-{{ block.id }}">Find your best fit</h2>
          <p class="bould-widget__subtitle" id="bould-widget-subtitle-{{ block.id }}">Upload a T-pose photo to unlock a personalized size recommendation.</p>
        </div>
        <button type="button" class="bould-widget__close" aria-label="Close">×</button>
      </header>

      <div class="bould-widget__body">
        <div class="bould-widget__screen bould-widget__screen--intro" data-screen="intro">
          <h3>How it works</h3>
          <div class="bould-widget__intro-grid">
            <div class="bould-widget__intro-step" data-intro-step="1">
              <div class="bould-widget__step-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
              </div>
              <span class="bould-widget__step-text">Upload a T-pose photo</span>
            </div>
            <div class="bould-widget__intro-step" data-intro-step="2">
              <div class="bould-widget__step-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
              </div>
              <span class="bould-widget__step-text">Enter your height</span>
            </div>
            <div class="bould-widget__intro-step" data-intro-step="3">
              <div class="bould-widget__step-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.38 3.4a2 2 0 0 0-2-2h-12.76a2 2 0 0 0-2 2l-.38 2.6a2 2 0 0 0 1.98 2.2h13.52a2 2 0 0 0 1.98-2.2z"/><path d="M16 14l-4 4-4-4"/></svg>
              </div>
              <span class="bould-widget__step-text">Get your size</span>
            </div>
          </div>
          <div class="bould-widget__actions bould-widget__actions--intro" data-intro-actions hidden>
            <button type="button" data-action="continue" class="bould-btn bould-btn--primary bould-btn--full">Continue</button>
          </div>
        </div>

        <div class="bould-widget__screen bould-widget__screen--form" data-screen="form" hidden>
          <p class="bould-widget__section-lede">Upload a T‑pose photo and enter your height. Choose centimeters or inches.</p>
          <form class="bould-widget__form">
            <div class="bould-widget__field">
              <span class="bould-widget__label">Photo</span>
              <label class="bould-widget__file-upload">
                <input type="file" accept="image/*" name="user_image" required />
                <div class="bould-widget__file-upload-content">
                  <div class="bould-widget__upload-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                  </div>
                  <span class="bould-widget__upload-text">Tap to upload T-pose</span>
                </div>
              </label>
            </div>
            <div class="bould-widget__field">
              <span class="bould-widget__label">Height</span>
              <div class="bould-widget__input-group">
                <input type="number" name="height" placeholder="0" min="80" max="250" inputmode="decimal" required class="bould-widget__input--height" />
                <div class="bould-widget__unit-toggle">
                  <select name="body_unit" class="bould-widget__unit-select">
                    <option value="cm" selected>cm</option>
                    <option value="inch">in</option>
                  </select>
                </div>
              </div>
            </div>
            <button type="submit" class="bould-btn bould-btn--primary bould-btn--full">Find my size</button>
            <p class="bould-widget__privacy">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:4px;display:inline-block;vertical-align:middle;"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
              Your photo is private and deleted after processing.
            </p>
          </form>
        </div>

        <div class="bould-widget__screen bould-widget__screen--loading" data-screen="loading" hidden>
          <h2 class="bould-widget__title" id="bould-widget-title-{{ block.id }}">Finding your best fit</h2>
          <div class="bould-widget__loading-state" data-loading-state>
            <p class="bould-widget__loading-text">Analyzing your image and creating a try‑on…</p>
            <p class="bould-widget__loading-generating" data-loading-generating hidden aria-hidden="true">Generating</p>
          </div>
          <p class="bould-widget__loading-feedback bould-widget__fade-text" data-loading-feedback hidden></p>
        </div>

        <div class="bould-widget__screen bould-widget__screen--result" data-screen="result" hidden>
          <img class="bould-widget__result-image bould-widget__result-stage" alt="Try on result" width="300" height="400" />
          <h4 class="bould-widget__size bould-widget__result-stage"></h4>
          <p class="bould-widget__feedback bould-widget__result-stage bould-widget__fade-text"></p>
          <p class="bould-widget__confidence bould-widget__result-stage"></p>
          <div class="bould-widget__actions">
            <button type="button" data-action="retake" class="bould-btn" style="margin-right: 0.5rem;">Retake</button>
            <button type="button" data-action="close" class="bould-btn">Done</button>
          </div>
        </div>

        <div class="bould-widget__screen bould-widget__screen--error" data-screen="error" hidden>
          <p class="bould-widget__section-lede">Something went wrong</p>
          <pre class="bould-widget__error"></pre>
          <div class="bould-widget__actions">
            <button type="button" data-action="back-to-form" class="bould-btn">Try again</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


